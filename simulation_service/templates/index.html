<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Simulation Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <style>
        :root {
            --bg: #0f172a; --bg-card: #1e293b; --text: #e2e8f0; --text-muted: #94a3b8;
            --border: #334155; --primary: #3b82f6; --primary-hover: #2563eb;
            --danger: #ef4444; --success: #10b981;
        }
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }
        .layout { max-width: 1600px; margin: 0 auto; padding: 2rem; display: grid; gap: 2rem; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        h1 { margin: 0; font-size: 1.5rem; }
        section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; }
        h2 { margin: 0 0 1rem 0; font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; color: #fbbf24; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.6rem; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        th { color: var(--text-muted); font-weight: 600; background: rgba(0,0,0,0.2); }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        /* Button Styles */
        .btn { 
            background: var(--primary); color: white; border: none; 
            padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; 
            font-size: 0.85rem; font-weight: 500; transition: all 0.2s;
        }
        .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--border); }
        .btn-secondary:hover { background: #475569; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #dc2626; }
        
        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .pagination {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .page-info {
            font-size: 0.9rem;
            color: var(--text);
            min-width: 150px;
            text-align: center;
            padding: 0.5rem 1rem;
            background: var(--bg);
            border-radius: 4px;
        }
        .divider {
            width: 1px;
            height: 30px;
            background: var(--border);
            margin: 0 0.5rem;
        }
    </style>
</head>
<body>
    <div class="layout">
        <header>
            <h1>üéØ Simulation Service</h1>
            <span style="color:var(--text-muted)">Port: 8100</span>
        </header>

        <!-- TOP STRATEGIES TABLE -->
        <section>
            <h2>Top Strategies (Sorted by SQN)</h2>
            <p style="margin:0 0 1rem 0; color:var(--text-muted); font-size:0.85rem;">
                System Quality Number: >3 = Excellent, 2-3 = Good, 1-2 = Fair, &lt;1 = Poor
            </p>
            
            <!-- TOOLBAR WITH PAGINATION AND ACTIONS -->
            <div class="toolbar">
                <div class="pagination">ARE HERE (lines ~82-88) -->
                    <button class="btn btn-secondary" onclick="goToPage('first')" id="btn-first">‚èÆ First</button>
                    <button class="btn btn-secondary" onclick="goToPage('prev')" id="btn-prev">‚óÄ Previous</button>
                    <span class="page-info" id="page-info">Page 1 of 1</span>')" id="btn-prev">‚óÄ Previous</button>
                    <button class="btn btn-secondary" onclick="goToPage('next')" id="btn-next">Next ‚ñ∂</button>
                    <button class="btn btn-secondary" onclick="goToPage('last')" id="btn-last">Last ‚è≠</button>
                </div>utton class="btn btn-secondary" onclick="goToPage('last')" id="btn-last">Last ‚è≠</button>
                </div>
                <div class="divider"></div>
                <div class="divider"></div>
                <div style="display:flex; gap:0.5rem;">
                    <button class="btn btn-secondary" onclick="loadTopStrategies()">üîÑ Refresh</button>
                    <button class="btn btn-danger" onclick="deleteAllHistory()">üóëÔ∏è Delete All History</button>
                </div>utton class="btn btn-secondary" onclick="loadTopStrategies()">üîÑ Refresh</button>
            </div>  <button class="btn btn-danger" onclick="deleteAllHistory()">üóëÔ∏è Delete All History</button>
                </div>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Ticker</th>
                        <th>Model</th>
                        <th>SQN</th>th>
                        <th>Return %</th>
                        <th>Hit Rate</th>
                        <th>Trades</th>h>
                        <th>Expectancy</th>
                        <th>Profit Factor</th>
                        <th>Threshold</th>>
                        <th>Z-Score</th>r</th>
                        <th>Vol Norm</th>>
                        <th>Use Bot</th>
                        <th>Regime Col</th>
                        <th>Allowed Regimes</th>
                        <th>Date</th>l</th>
                    </tr>th>Allowed Regimes</th>
                </thead><th>Date</th>
                <tbody id="top-strategies-body">
                    <tr><td colspan="16" style="text-align:center; padding:2rem; color:var(--text-muted)">Loading...</td></tr>
                </tbody>d="top-strategies-body">
            </table><tr><td colspan="16" style="text-align:center; padding:2rem; color:var(--text-muted)">Loading...</td></tr>
        </section>tbody>
    </div>  </table>
        </section>
    <script>
        // Pagination State
        let currentOffset = 0;
        const pageSize = 15;
        let totalRecords = 0;;
        const pageSize = 15;
        function updatePaginationButtons() {
            const totalPages = Math.ceil(totalRecords / pageSize) || 1;
            const currentPage = Math.floor(currentOffset / pageSize) + 1;
            const totalPages = Math.ceil(totalRecords / pageSize) || 1;
            document.getElementById('btn-first').disabled = currentOffset === 0;
            document.getElementById('btn-prev').disabled = currentOffset === 0;
            document.getElementById('btn-next').disabled = currentOffset + pageSize >= totalRecords;
            document.getElementById('btn-last').disabled = currentOffset + pageSize >= totalRecords;
        }   document.getElementById('btn-next').disabled = currentOffset + pageSize >= totalRecords;
            document.getElementById('btn-last').disabled = currentOffset + pageSize >= totalRecords;
        // Lines ~117-136: Pagination logic
        function goToPage(action) {
            const totalPages = Math.ceil(totalRecords / pageSize) || 1;tion goToPage(action) {
             = Math.ceil(totalRecords / pageSize) || 1;
            switch(action) {
                case 'first':
                    currentOffset = 0;t':
                    break;ffset = 0;
                case 'prev':
                    currentOffset = Math.max(0, currentOffset - pageSize);':
                    break;ffset = Math.max(0, currentOffset - pageSize);
                case 'next':
                    if (currentOffset + pageSize < totalRecords) {
                        currentOffset += pageSize;f (currentOffset + pageSize < totalRecords) {
                    }rrentOffset += pageSize;
                    break;
                case 'last':
                    currentOffset = Math.max(0, (totalPages - 1) * pageSize);':
                    break;       currentOffset = Math.max(0, (totalPages - 1) * pageSize);
            }
            loadTopStrategies();   }
        }            loadTopStrategies();

        // Lines ~138-152: Delete all history
        async function deleteAllHistory() {
            if (!confirm("‚ö†Ô∏è Are you sure you want to DELETE ALL simulation history?\n\nThis action cannot be undone.")) return;if (!confirm("‚ö†Ô∏è Are you sure you want to DELETE ALL simulation history?\n\nThis action cannot be undone.")) return;
            if (prompt("Type 'DELETE' to confirm:") !== "DELETE") return;rompt("Type 'DELETE' to confirm:") !== "DELETE") return;
            
            const res = await fetch('/history/all', { method: 'DELETE' });
            if (res.ok) {h('/history/all', { method: 'DELETE' });
                currentOffset = 0;
                totalRecords = 0;
                loadTopStrategies();
                alert("‚úÖ All simulation history deleted.");TopStrategies();
            } else {ed.");
                alert("‚ùå Failed to delete history."); else {
            }t("‚ùå Failed to delete history.");
        }

        async function loadTopStrategies() {   console.error(e);
            const tbody = document.getElementById('top-strategies-body');       alert("‚ùå Error: " + e.message);
            const pageInfo = document.getElementById('page-info');            }
            
            try {
                const res = await fetch(`/history/top?limit=${pageSize}&offset=${currentOffset}`);
                const data = await res.json();const tbody = document.getElementById('top-strategies-body');
                 pageInfo = document.getElementById('page-info');
                // Handle response format: {items: [], total: N}
                const rows = data.items || data || [];
                totalRecords = data.total || rows.length;const res = await fetch(`/history/top?limit=${pageSize}&offset=${currentOffset}`);
                
                // Update pagination info
                const totalPages = Math.ceil(totalRecords / pageSize) || 1;tal: N}
                const currentPage = Math.floor(currentOffset / pageSize) + 1;const rows = data.items || data || [];
                pageInfo.innerText = `Page ${currentPage} of ${totalPages} (${totalRecords} total)`; || rows.length;
                
                updatePaginationButtons();
                
                if (!rows.length) {const currentPage = Math.floor(currentOffset / pageSize) + 1;
                    tbody.innerHTML = `<tr><td colspan="16" style="text-align:center; padding:2rem; color:var(--text-muted)"> ${currentPage} of ${totalPages} (${totalRecords} total)`;
                        No simulation results found.<br>Run simulations to populate this table.
                    </td></tr>`;tons();
                    return;
                }
                TML = `<tr><td colspan="16" style="text-align:center; padding:2rem; color:var(--text-muted)">
                tbody.innerHTML = rows.map((r, idx) => {simulation results found.<br>Run simulations to populate this table.
                    const rank = currentOffset + idx + 1;   </td></tr>`;
                    const rankSuffix = rank === 1 ? 'st' : rank === 2 ? 'nd' : rank === 3 ? 'rd' : 'th';    return;
                    
                    // Color code SQN
                    let sqnColor = "#94a3b8";
                    if (r.sqn >= 3.0) sqnColor = "#34d399";const rank = currentOffset + idx + 1;
                    else if (r.sqn >= 2.0) sqnColor = "#fbbf24";= rank === 1 ? 'st' : rank === 2 ? 'nd' : rank === 3 ? 'rd' : 'th';
                    else if (r.sqn >= 1.0) sqnColor = "#60a5fa";
                    else if (r.sqn < 0) sqnColor = "#ef4444";
                    
                    const retColor = r.return_pct >= 0 ? '#34d399' : '#ef4444';
                    const hitColor = r.hit_rate_pct >= 50 ? '#34d399' : '#ef4444';4";
                    else if (r.sqn >= 1.0) sqnColor = "#60a5fa";
                    // Extract params
                    const p = r.params || {};
                    const threshold = p.min_prediction_threshold != null ? p.min_prediction_threshold.toFixed(4) : '-';const retColor = r.return_pct >= 0 ? '#34d399' : '#ef4444';
                    const zScore = p.enable_z_score_check ? 'Y' : 'N';r.hit_rate_pct >= 50 ? '#34d399' : '#ef4444';
                    const volNorm = p.volatility_normalization ? 'Y' : 'N';
                    const useBot = p.use_bot ? 'Y' : 'N';
                    const regimeCol = p.regime_col || 'None';
                    const allowedRegimes = p.allowed_regimes ? p.allowed_regimes.join(',') : 'All';p.min_prediction_threshold.toFixed(4) : '-';
                     ? 'Y' : 'N';
                    return `n ? 'Y' : 'N';
                    <tr>
                        <td><strong>${rank}${rankSuffix}</strong></td>const regimeCol = p.regime_col || 'None';
                        <td><strong>${r.ticker || 'N/A'}</strong></td>lowedRegimes = p.allowed_regimes ? p.allowed_regimes.join(',') : 'All';
                        <td style="font-family:monospace; font-size:0.75rem;">${r.model_id ? r.model_id.substring(0,12) + '...' : 'N/A'}</td>
                        <td style="font-weight:bold; color:${sqnColor}; background:rgba(0,0,0,0.2); padding:0.4rem 0.6rem; border-radius:4px;">
                            ${r.sqn != null ? r.sqn.toFixed(2) : 'N/A'}
                        </td>
                        <td style="color:${retColor}; font-weight:600;">${r.return_pct != null ? r.return_pct.toFixed(2) + '%' : 'N/A'}</td>
                        <td style="color:${hitColor};">${r.hit_rate_pct != null ? r.hit_rate_pct.toFixed(1) + '%' : 'N/A'}</td>5rem;">${r.model_id ? r.model_id.substring(0,12) + '...' : 'N/A'}</td>
                        <td>${r.trades_count || 0}</td>tyle="font-weight:bold; color:${sqnColor}; background:rgba(0,0,0,0.2); padding:0.4rem 0.6rem; border-radius:4px;">
                        <td>${r.expectancy != null ? r.expectancy.toFixed(2) : '-'}</td>
                        <td>${r.profit_factor != null ? r.profit_factor.toFixed(2) : '-'}</td>
                        <td>${threshold}</td>ont-weight:600;">${r.return_pct != null ? r.return_pct.toFixed(2) + '%' : 'N/A'}</td>
                        <td style="color:${zScore === 'Y' ? '#34d399' : '#ef4444'}">${zScore}</td>rate_pct.toFixed(1) + '%' : 'N/A'}</td>
                        <td style="color:${volNorm === 'Y' ? '#34d399' : '#ef4444'}">${volNorm}</td>
                        <td style="color:${useBot === 'Y' ? '#34d399' : '#ef4444'}">${useBot}</td> null ? r.expectancy.toFixed(2) : '-'}</td>
                        <td style="font-size:0.8rem;">${regimeCol}</td>
                        <td style="font-size:0.8rem;">${allowedRegimes}</td>
                        <td style="font-size:0.75rem; color:var(--text-muted);">${r.timestamp ? r.timestamp.split('T')[0] : 'N/A'}</td>
                    </tr>: '#ef4444'}">${volNorm}</td>
                    `;4444'}">${useBot}</td>
                }).join('');
                td style="font-size:0.8rem;">${allowedRegimes}</td>
            } catch(e) {  <td style="font-size:0.75rem; color:var(--text-muted);">${r.timestamp ? r.timestamp.split('T')[0] : 'N/A'}</td>
                console.error("Failed to load top strategies:", e);
                tbody.innerHTML = `<tr><td colspan="16" style="text-align:center; color:var(--danger);">    `;
                    ‚ùå Error loading data: ${e.message}'');
                </td></tr>`;
            }
        }tegies:", e);
TML = `<tr><td colspan="16" style="text-align:center; color:var(--danger);">
        // Initial load       ‚ùå Error loading data: ${e.message}
        window.addEventListener("load", () => {       </td></tr>`;
            loadTopStrategies();            }
            setInterval(loadTopStrategies, 30000);
        });
    </script>
</body>
</html></body>
</html>