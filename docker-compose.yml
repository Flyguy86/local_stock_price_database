services:
  # ============================================
  # PostgreSQL - Shared state for orchestrator
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: orchestrator_postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: orchestrator
      POSTGRES_PASSWORD: orchestrator_secret
      POSTGRES_DB: strategy_factory
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./orchestrator_service/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orchestrator -d strategy_factory"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================
  # Orchestrator - Recursive Strategy Factory
  # ============================================
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.orchestrator
    container_name: orchestrator
    ports:
      - "8400:8400"
    volumes:
      - ./data:/app/data
      - ./orchestrator_service:/app/orchestrator_service
    environment:
      TRAINING_URL: http://training_service:8200
      SIMULATION_URL: http://simulation_service:8300
      FEATURE_URL: http://feature_builder:8100
      POSTGRES_URL: postgresql://orchestrator:orchestrator_secret@postgres:5432/strategy_factory
      DEFAULT_MAX_GENERATIONS: "4"
      LOG_LEVEL: INFO
    depends_on:
      postgres:
        condition: service_healthy
      training_service:
        condition: service_started
      simulation_service:
        condition: service_started
      feature_builder:
        condition: service_started

  # ============================================
  # API - Ingestion Service
  # ============================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      ALPACA_KEY_ID: ${ALPACA_KEY_ID:-}
      ALPACA_SECRET_KEY: ${ALPACA_SECRET_KEY:-}
      ALPACA_BASE_URL: ${ALPACA_BASE_URL:-https://data.alpaca.markets}
    volumes:
      - ./data:/app/data
      - .:/app  # Mount source code as volume
    ports:
      - "8000:8000"

  feature_builder:
    build:
      context: .
      dockerfile: Dockerfile.feature
    environment:
      SOURCE_DUCKDB_PATH: ${SOURCE_DUCKDB_PATH:-/app/data/duckdb/local.db}
      DEST_DUCKDB_PATH: ${DEST_DUCKDB_PATH:-/app/data/duckdb/features.db}
      DEST_PARQUET_DIR: ${DEST_PARQUET_DIR:-/app/data/features_parquet}
      LOG_LEVEL: ${FEATURE_BUILDER_LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data
      - .:/app
    command: ["uvicorn", "feature_service.web:app", "--host", "0.0.0.0", "--port", "8100"]
    ports:
      - "8100:8100"

  training_service:
    build:
      context: .
      dockerfile: Dockerfile.training
    environment:
      LOG_LEVEL: INFO
    volumes:
      - ./data:/app/data
      - .:/app
    command: ["uvicorn", "training_service.main:app", "--host", "0.0.0.0", "--port", "8200", "--reload"]
    ports:
      - "8200:8200"

  simulation_service:
    build:
      context: .
      dockerfile: Dockerfile.simulation
    environment:
      LOG_LEVEL: INFO
      MODELS_DIR: /app/data/models
      FEATURES_PATH: /app/data/features_parquet
      PYTHONPATH: /app
    volumes:
      - ./data:/app/data
      - .:/app
    command: ["uvicorn", "simulation_service.main:app", "--host", "0.0.0.0", "--port", "8300", "--reload"]
    ports:
      - "8300:8300"

  optimization:
    build:
      context: .
      dockerfile: Dockerfile.optimize
    container_name: optimization_c2
    command: python optimization_service/main.py
    ports:
      - "8002:8002"
    volumes:
      - .:/app
    environment:
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: /app

  # ============================================
  # Priority Worker - Pulls from PostgreSQL queue
  # ============================================
  priority_worker:
    build:
      context: .
      dockerfile: Dockerfile.optimize
    container_name: priority_worker_1
    command: python -m orchestrator_service.priority_worker
    volumes:
      - ./data:/app/data
      - .:/app
    environment:
      POSTGRES_URL: postgresql://orchestrator:orchestrator_secret@postgres:5432/strategy_factory
      SIMULATION_URL: http://simulation_service:8300
      WORKER_ID: priority_worker_1
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: /app
    depends_on:
      postgres:
        condition: service_healthy
      simulation_service:
        condition: service_started

volumes:
  postgres_data:
