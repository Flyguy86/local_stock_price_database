version: "3.9"
services:
  api:
    build: .
    environment:
      ALPACA_KEY_ID: ${ALPACA_KEY_ID:-}
      ALPACA_SECRET_KEY: ${ALPACA_SECRET_KEY:-}
      ALPACA_BASE_URL: ${ALPACA_BASE_URL:-https://data.alpaca.markets}
    volumes:
      - ./data:/app/data
      - .:/app
    ports:
      - "8000:8000"

  feature_builder:
    build:
      context: .
      dockerfile: Dockerfile.feature
    environment:
      SOURCE_DUCKDB_PATH: ${SOURCE_DUCKDB_PATH:-/app/data/duckdb/local.db}
      DEST_DUCKDB_PATH: ${DEST_DUCKDB_PATH:-/app/data/duckdb/features.db}
      DEST_PARQUET_DIR: ${DEST_PARQUET_DIR:-/app/data/features_parquet}
      LOG_LEVEL: ${FEATURE_BUILDER_LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data
      - .:/app
    command: ["uvicorn", "feature_service.web:app", "--host", "0.0.0.0", "--port", "8100"]
    ports:
      - "8100:8100"

  training_service:
    build:
      context: .
      dockerfile: Dockerfile.training
    environment:
      LOG_LEVEL: INFO
    volumes:
      - ./data:/app/data
      - .:/app
    command: ["uvicorn", "training_service.main:app", "--host", "0.0.0.0", "--port", "8200", "--reload"]
    ports:
      - "8200:8200"
