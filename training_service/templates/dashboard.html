<!doctype html>
    <html lang="en">
    <head>
      <meta charset="utf-8" />
      <title> Training Service Dashboard</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        :root {
          --bg: #0f172a;
          --bg-card: #1e293b;
          --text: #e2e8f0;
          --text-muted: #94a3b8;
          --border: #334155;
          --primary: #8b5cf6;
          --primary-hover: #7c3aed;
          --danger: #ef4444;
          --success: #10b981;
        }
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; line-height: 1.5; }
        * { box-sizing: border-box; }
        
        .layout { max-width: 1200px; margin: 0 auto; padding: 2rem; display: grid; gap: 2rem; }
        
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        h1 { margin: 0; font-size: 1.5rem; font-weight: 600; background: linear-gradient(to right, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        h2 { margin: 0; font-size: 1.1rem; font-weight: 600; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        
        .row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .group { display: flex; flex-direction: column; gap: 0.25rem; }
        
        label { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
        input, select, textarea { background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text); padding: 0.5rem; border-radius: 4px; outline: none;  }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        
        button { background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        button.secondary { background: var(--border); }
        button.secondary:hover { background: #475569; }
        
        /* Specific header colors for sections */
        .color-enet h2 { color: #f472b6; border-color: rgba(244, 114, 182, 0.3); }
        .color-xgb h2 { color: #34d399; border-color: rgba(52, 211, 153, 0.3); }
        .color-lgbm h2 { color: #fbbf24; border-color: rgba(251, 191, 36, 0.3); }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        th { color: var(--text-muted); font-weight: 600; font-size: 0.85rem; }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: var(--border); }
        .badge.completed { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .badge.failed { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .badge.running { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        
        pre { background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 6px; overflow: auto; }
        
        dialog { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; max-width: 600px; width: 90%; }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        
        details { border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem; margin-top: 0.5rem; background: rgba(0,0,0,0.1); }
        summary { cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }

        /* Help tip styles */
        .help-tip {
          position: relative;
          display: inline-block;
          cursor: pointer;
        }
        .tip-content {
          display: none;
          position: absolute;
          bottom: 125%;
          left: 50%;
          transform: translateX(-50%);
          background: var(--bg-card);
          color: var(--text);
          padding: 0.5rem;
          border-radius: 6px;
          border: 1px solid var(--border);
          white-space: nowrap;
          z-index: 10;
        }
        .help-tip:hover .tip-content {
          display: block;
        }
      </style>
    </head>
    <body>
      <div class="layout">
        <header>
            <div style="display:flex; align-items:center; gap:1rem;">
                <h1>Training Service</h1>
            </div>
            <div class="badge">Port: 8200</div>
        </header>

        <dialog id="report-modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem">
                <h2 style="margin:0; border:none;" id="report-title">Training Report</h2>
                <button class="secondary" onclick="closeReport()">Close</button>
            </div>
            <div id="report-content" style="max-height: 70vh; overflow-y: auto;"></div>
        </dialog>
        
        <!-- ELASTIC NET -->
        <section class="color-enet">
            <h2>Elastic Net</h2>
            <div class="row">
                <div class="group"><label>Data Options</label><select id="enet_data_options" onchange="updateSymbols('enet')" style="max-width: 200px;"><option value="">Loading...</option></select></div>
                <div class="group"><label>Symbol</label><select id="enet_symbol" style="min-width: 100px;"><option value="">--</option></select></div>
                <div class="group"><label>Parent (Feat)</label><select id="enet_parent_model" class="parent-model-select" onchange="onParentModelChange('enet')"><option value="">(None)</option></select></div>
                <div class="group"><label>Pred. Type</label>
                    <select id="enet_target_transform">
                        <option value="log_return" selected>Log Return</option>
                        <option value="pct_change">Pct Change</option> 
                        <option value="none">Raw Price</option>
                    </select>
                </div>
            </div>
            <div class="row" style="margin-top:0.5rem">
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        Alpha (a)
                        <div class="help-tip">
                            ‚ÑπÔ∏è
                            <div class="tip-content">
                                <strong>Controls Total Penalty (Regularization)</strong><br>
                                Higher = Fewer features (Simpler model).<br>
                                Lower = More features (Risks overfitting).<br>
                                <hr style="border:0; border-top:1px solid #475569; margin:4px 0;">
                                <em>Search Range: 0.00001 to 0.1</em><br>
                                <em>Default: 1.0</em>
                            </div>
                        </div>
                    </label>
                    <input type="number" step="0.00001" id="enet_alpha" value="1.0" min="0" style="width:100px">
                </div>
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        L1 Ratio
                        <div class="help-tip">
                            ‚ÑπÔ∏è
                            <div class="tip-content">
                                <strong>Balance between Lasso (L1) and Ridge (L2)</strong><br>
                                <code>1.0</code> = Lasso (Zeros out features)<br>
                                <code>0.0</code> = Ridge (Shrinks coefficients)<br>
                                <code>0.5</code> = Balanced mix<br>
                                <hr style="border:0; border-top:1px solid #475569; margin:4px 0;">
                                <em>Range: 0.0 to 1.0</em>
                            </div>
                        </div>
                    </label>
                    <input type="number" step="0.1" id="enet_l1_ratio" value="0.5" min="0" max="1" style="width:80px">
                </div>
                <span style="flex-grow:1"></span>
                <!-- Method A Inputs -->
                <div class="group"><label>Target</label><select id="enet_target"><option value="close">Close</option><option value="open">Open</option><option value="high">High</option><option value="low">Low</option></select></div>
                <div class="group"><label>Timeframe</label><select id="enet_timeframe"><option value="1m">1m</option><option value="5m">5m</option><option value="1h">1h</option><option value="1d">1d</option></select></div>
                <button onclick="trainModel('enet', 'elastic_net')">Train Elastic Net</button>
            </div>
            
            <details>
                <summary>Advanced / Features / Context</summary>
                <div class="row" style="margin-top:0.5rem">
                   <div class="group"><label>Ctx 1</label><select id="enet_ctx1" class="ctx-select"><option value="">(None)</option></select></div>
                   <div class="group"><label>Ctx 2</label><select id="enet_ctx2" class="ctx-select"><option value="">(None)</option></select></div>
                   <div class="group"><label>Ctx 3</label><select id="enet_ctx3" class="ctx-select"><option value="">(None)</option></select></div>
                </div>
                <div class="group" style="margin-top:0.5rem">
                    <label>JSON Overrides</label>
                    <textarea id="enet_hyperparameters" style="width:100%; height:40px; font-family:monospace; font-size:0.8rem" placeholder="{}"></textarea>
                </div>
                <!-- Feature Selection Container -->
                <div id="enet_feature_ui" style="display:none; margin-top:0.5rem; border-top:1px solid var(--border); padding-top:0.5rem">
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table style="width:100%; font-size:0.8rem;">
                            <thead><tr><th>Select</th><th>Feature</th><th>Imp</th></tr></thead>
                            <tbody id="enet_feat_body"></tbody>
                        </table>
                    </div>
                </div>
            </details>
        </section>

        <!-- XGBOOST -->
        <section class="color-xgb">
            <h2>XGBoost</h2>
            <div class="row">
                <div class="group"><label>Data Options</label><select id="xgb_data_options" onchange="updateSymbols('xgb')" style="max-width: 200px;"><option value="">Loading...</option></select></div>
                <div class="group"><label>Symbol</label><select id="xgb_symbol" style="min-width: 100px;"><option value="">--</option></select></div>
                <div class="group"><label>Parent (Feat)</label><select id="xgb_parent_model" class="parent-model-select" onchange="onParentModelChange('xgb')"><option value="">(None)</option></select></div>
                <div class="group"><label>Pred. Type</label>
                    <select id="xgb_target_transform">
                        <option value="log_return" selected>Log Return</option>
                        <option value="pct_change">Pct Change</option>
                        <option value="none">Raw Price</option>
                    </select>
                </div>
            </div>
            <div class="row" style="margin-top:0.5rem">
                <!-- n_estimators -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        Est.
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content>
                            <strong>Number of Trees (n_estimators)</strong><br>
                            Pair high count with low learning rate.<br>
                            <em>Range: 100-1000 (Default: 100)</em>
                        </div></div>
                    </label>
                    <input type="number" id="xgb_n_estimators" value="100" step="50" style="width:70px">
                </div>

                <!-- learning_rate -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        Eta
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Learning Rate (eta)</strong><br>
                            Lower is safer / prevents overfitting.<br>
                            <em>Range: 0.01 to 0.1 (Default: 0.1)</em>
                        </div></div>
                    </label>
                    <input type="number" step="0.01" id="xgb_learning_rate" value="0.1" style="width:70px">
                </div>
                
                <!-- max_depth -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        Depth
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Max Tree Depth</strong><br>
                            Deep trees overfit financial noise.<br>
                            <em>Range: 3-9 (Default: 6)</em>
                        </div></div>
                    </label>
                    <input type="number" id="xgb_max_depth" value="6" min="1" max="15" style="width:60px">
                </div>

                <!-- subsample -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        Sub
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Subsample Ratio</strong><br>
                            Randomly drops data rows to prevent "memorizing".<br>
                            <em>Range: 0.6 to 0.9 (Default: 1.0)</em>
                        </div></div>
                    </label>
                    <input type="number" step="0.1" id="xgb_subsample" value="1.0" min="0.1" max="1.0" style="width:60px">
                </div>

                <!-- colsample_bytree -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        Col
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Feature Subsample</strong><br>
                            Randomly drops features per tree.<br>
                            <em>Range: 0.5 to 0.8 (Default: 1.0)</em>
                        </div></div>
                    </label>
                    <input type="number" step="0.1" id="xgb_colsample_bytree" value="1.0" min="0.1" max="1.0" style="width:60px">
                </div>

                 <!-- min_child_weight -->
                 <div class="group">
                    <label style="display:flex; align-items:center;">
                        ChildW
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Min Child Weight</strong><br>
                            Prevents leaves based on outliers.<br>
                            Target [1, 5, 10] for SQN > 3.0.<br>
                            <em>Default: 1</em>
                        </div></div>
                    </label>
                    <input type="number" id="xgb_min_child_weight" value="1" min="0" style="width:60px">
                </div>

                <span style="flex-grow:1"></span>
                <div class="group"><label>Target</label><select id="xgb_target"><option value="close">Close</option><option value="open">Open</option><option value="high">High</option><option value="low">Low</option></select></div>
                <div class="group"><label>Timeframe</label><select id="xgb_timeframe"><option value="1m">1m</option><option value="5m">5m</option><option value="1h">1h</option><option value="1d">1d</option></select></div>
                <button onclick="trainModel('xgb', 'xgboost')">Train XGBoost</button>
            </div>
            <details>
                <summary>Advanced / Features / Context</summary>
                <div class="row" style="margin-top:0.5rem">
                    <!-- Hybrid / Residual Base Model Selection -->
                    <div class="group">
                        <label style="display:flex; align-items:center;">
                            Hybrid Base (Resid)
                            <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                                <strong>Residual Learning / Hybrid</strong><br>
                                Select an Elastic Net model.<br>
                                XGBoost will train on the <em>errors</em> (residuals) of this linear model.<br>
                                Good for capturing non-linear alpha missed by the baseline.
                            </div></div>
                        </label>
                        <select id="xgb_residual_base_model" style="max-width:200px"><option value="">(None)</option></select>
                    </div>

                    <div class="group"><label>Ctx 1</label><select id="xgb_ctx1" class="ctx-select"><option value="">(None)</option></select></div>
                    <div class="group"><label>Ctx 2</label><select id="xgb_ctx2" class="ctx-select"><option value="">(None)</option></select></div>
                    <div class="group"><label>Ctx 3</label><select id="xgb_ctx3" class="ctx-select"><option value="">(None)</option></select></div>
                 </div>
                 <div class="group" style="margin-top:0.5rem">
                     <label>JSON Overrides</label>
                     <textarea id="xgb_hyperparameters" style="width:100%; height:40px; font-family:monospace; font-size:0.8rem" placeholder="{}"></textarea>
                 </div>
                 <div id="xgb_feature_ui" style="display:none; margin-top:0.5rem; border-top:1px solid var(--border); padding-top:0.5rem">
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table style="width:100%; font-size:0.8rem;">
                            <thead><tr><th>Select</th><th>Feature</th><th>Imp</th></tr></thead>
                            <tbody id="xgb_feat_body"></tbody>
                        </table>
                    </div>
                </div>
            </details>
        </section>

        <!-- LIGHTGBM -->
        <section class="color-lgbm">
            <h2>LightGBM</h2>
            <div class="row">
                <div class="group"><label>Data Options</label><select id="lgbm_data_options" onchange="updateSymbols('lgbm')" style="max-width: 200px;"><option value="">Loading...</option></select></div>
                <div class="group"><label>Symbol</label><select id="lgbm_symbol" style="min-width: 100px;"><option value="">--</option></select></div>
                <div class="group"><label>Parent (Feat)</label><select id="lgbm_parent_model" class="parent-model-select" onchange="onParentModelChange('lgbm')"><option value="">(None)</option></select></div>
                <div class="group"><label>Pred. Type</label>
                    <select id="lgbm_target_transform">
                        <option value="log_return" selected>Log Return</option>
                        <option value="pct_change">Pct Change</option>
                        <option value="none">Raw Price</option>
                    </select>
                </div>
            </div>
            <div class="row" style="margin-top:0.5rem">
                 <!-- n_estimators -->
                 <div class="group">
                    <label style="display:flex; align-items:center;">
                        Est.
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Number of Trees</strong><br>
                            <em>Default: 100</em>
                        </div></div>
                    </label>
                    <input type="number" id="lgbm_n_estimators" value="100" step="50" style="width:70px">
                </div>

                <!-- learning_rate -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        Eta
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Learning Rate</strong><br>
                            <em>Default: 0.1</em>
                        </div></div>
                    </label>
                    <input type="number" step="0.01" id="lgbm_learning_rate" value="0.1" style="width:70px">
                </div>

                <!-- num_leaves -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        Leaves
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Num Leaves</strong><br>
                            Main control for complexity.<br>
                            <em>Range: 20-150 (Default: 31)</em>
                        </div></div>
                    </label>
                    <input type="number" id="lgbm_num_leaves" value="31" step="10" min="2" style="width:60px">
                </div>

                <!-- min_data_in_leaf -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        MinData
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Min Data Inner Leaf</strong><br>
                            Critical to avoid overfitting.<br>
                            <em>Range: 50-500 (Default: 20)</em>
                        </div></div>
                    </label>
                    <input type="number" id="lgbm_min_data_in_leaf" value="20" step="10" min="1" style="width:60px">
                </div>

                <!-- feature_fraction -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        FeatFrac
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Feature Fraction</strong><br>
                            Randomly drops features (like colsample).<br>
                            <em>Range: 0.5 to 0.9 (Default: 1.0)</em>
                        </div></div>
                    </label>
                    <input type="number" id="lgbm_feature_fraction" value="1.0" step="0.1" min="0.1" max="1.0" style="width:60px">
                </div>

                <!-- lambda_l1 -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        L1
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Lambda L1</strong><br>
                            Lasso Regularization.<br>
                            <em>Range: 0-100 (Default: 0)</em>
                        </div></div>
                    </label>
                    <input type="number" id="lgbm_lambda_l1" value="0.0" step="0.1" min="0" style="width:60px">
                </div>

                <!-- lambda_l2 -->
                <div class="group">
                    <label style="display:flex; align-items:center;">
                        L2
                        <div class="help-tip">‚ÑπÔ∏è<div class="tip-content">
                            <strong>Lambda L2</strong><br>
                            Ridge Regularization.<br>
                            <em>Range: 0-100 (Default: 0)</em>
                        </div></div>
                    </label>
                    <input type="number" id="lgbm_lambda_l2" value="0.0" step="0.1" min="0" style="width:60px">
                </div>

                <span style="flex-grow:1"></span>
                <div class="group"><label>Target</label><select id="lgbm_target"><option value="close">Close</option><option value="open">Open</option><option value="high">High</option><option value="low">Low</option></select></div>
                <div class="group"><label>Timeframe</label><select id="lgbm_timeframe"><option value="1m">1m</option><option value="5m">5m</option><option value="1h">1h</option><option value="1d">1d</option></select></div>
                <button onclick="trainModel('lgbm', 'lightgbm')">Train LightGBM</button>
            </div>
            <details>
                <summary>Advanced / Features / Context</summary>
                <div class="row" style="margin-top:0.5rem">
                    <div class="group"><label>Ctx 1</label><select id="lgbm_ctx1" class="ctx-select"><option value="">(None)</option></select></div>
                    <div class="group"><label>Ctx 2</label><select id="lgbm_ctx2" class="ctx-select"><option value="">(None)</option></select></div>
                    <div class="group"><label>Ctx 3</label><select id="lgbm_ctx3" class="ctx-select"><option value="">(None)</option></select></div>
                 </div>
                 <div class="group" style="margin-top:0.5rem">
                     <label>JSON Overrides</label>
                     <textarea id="lgbm_hyperparameters" style="width:100%; height:40px; font-family:monospace; font-size:0.8rem" placeholder="{}"></textarea>
                 </div>
                 <div id="lgbm_feature_ui" style="display:none; margin-top:0.5rem; border-top:1px solid var(--border); padding-top:0.5rem">
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table style="width:100%; font-size:0.8rem;">
                            <thead><tr><th>Select</th><th>Feature</th><th>Imp</th></tr></thead>
                            <tbody id="lgbm_feat_body"></tbody>
                        </table>
                    </div>
                </div>
            </details>
        </section>

        <!-- DEBUG LOGS -->
        <section>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>System Logs (Debug)</h2>
                <button class="secondary" onclick="updateLogs()">Refresh Logs</button>
            </div>
            <div id="log-container" style="background:#0f172a; color:#10b981; font-family:'Courier New', monospace; height:200px; overflow-y:scroll; padding:0.75rem; font-size:0.75rem; border:1px solid #334155; border-radius:4px; white-space:pre-wrap;">Loading logs...</div>
        </section>
        
        <script>
            // Simple model registry integration
            async function loadModels() {
                // Implementation in JS file
            }
        </script>
        
        <section>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Model Registry</h2>
                <div style="display:flex; gap:0.5rem">
                     <button class="secondary" onclick="deleteAllModels()" style="color:#fca5a5; border-color: #ef4444; font-size: 0.8rem; padding: 0.25rem 0.5rem;">üóë Delete All</button>
                     <button class="secondary" onclick="loadModels()">Refresh</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Algo</th>
                        <th>Symbol</th>
                        <th>TF</th>
                        <th>Status</th>
                        <th>Metrics</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="models-body"></tbody>
            </table>
        </section>
      </div>
      <script src="/static/js/dashboard.js"></script>
    </body>
    </html>
