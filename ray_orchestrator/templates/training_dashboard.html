<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ray Orchestrator - Walk-Forward Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
        
        .sidebar {
            width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }
        
        .sidebar h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .api-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .api-section h3 {
            color: #555;
            font-size: 1em;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .api-section h3:hover {
            color: #667eea;
        }
        
        .api-section h3::before {
            content: '‚ñº ';
            font-size: 0.8em;
            transition: transform 0.3s;
            display: inline-block;
        }
        
        .api-section h3.collapsed::before {
            transform: rotate(-90deg);
        }
        
        .curl-example {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 10px;
            position: relative;
            transition: box-shadow 0.3s ease;
        }
        
        .curl-example.updating {
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }
        
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .copy-btn:hover {
            background: #5568d3;
        }
        
        .copy-btn.copied {
            background: #28a745;
        }
        
        .container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        .help-text {
            font-size: 0.85em;
            color: #888;
            margin-top: 4px;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        
        .symbol-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .symbol-item:hover {
            background: #e9ecef;
        }
        
        .symbol-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .algorithm-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .algorithm-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .algorithm-item:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        
        .algorithm-item input[type="radio"] {
            margin-right: 8px;
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .windows-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .windows-input input {
            flex: 1;
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .links {
            margin-top: 30px;
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
        }
        
        .links a {
            display: inline-block;
            margin-right: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- API Reference Sidebar -->
    <div class="sidebar">
        <h2>üîå API Reference</h2>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Start Training</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="trainCurl">curl -X POST http://localhost:8265/train/walk-forward \
  -H "Content-Type: application/json" \
  -d '{
    "symbols": ["GOOGL"],
    "model_type": "xgboost",
    "start_date": "2024-01-01",
    "end_date": "2024-12-31",
    "num_samples": 50
  }'</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Generate Folds</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="foldsCurl">curl -X POST http://localhost:8265/streaming/generate-folds \
  -H "Content-Type: application/json" \
  -d '{
    "symbol": "<span class="param-symbol">AAPL</span>",
    "start_date": "<span class="param-start-date">2020-01-01</span>",
    "end_date": "<span class="param-end-date">2024-12-31</span>",
    "train_months": <span class="param-train-months">12</span>,
    "test_months": <span class="param-test-months">3</span>,
    "step_months": <span class="param-step-months">3</span>
  }'</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Backtest Model</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="backtestCurl">curl -X POST http://localhost:8265/backtest/validate \
  -H "Content-Type: application/json" \
  -d '{
    "experiment_name": "walk_forward_xgboost_GOOGL",
    "initial_capital": 100000.0,
    "commission": 0.001,
    "slippage": 0.0005
  }'</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Get Backtest Results</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="resultsCurl">curl -X GET http://localhost:8265/backtest/results/walk_forward_xgboost_GOOGL</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">List Experiments</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="experimentsCurl">curl -X GET http://localhost:8265/backtest/experiments</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Check Status</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="statusCurl">curl -X GET http://localhost:8265/streaming/status</span>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 8px;">
            <h3 style="font-size: 0.9em; color: #666; margin-bottom: 10px;">üí° Quick Tips</h3>
            <ul style="font-size: 0.85em; color: #666; margin-left: 20px;">
                <li>Curl examples update as you fill the form</li>
                <li>Click headers to collapse sections</li>
                <li>Use Copy button for easy clipboard access</li>
                <li>Port 8265 is Ray Dashboard default</li>
            </ul>
        </div>
    </div>
    
    <div class="container">
        <h1>üöÄ Ray Orchestrator - Walk-Forward Training</h1>
        <p class="subtitle">Configure and launch ML training with proper walk-forward validation</p>
        
        <div id="loadingData" class="loading">
            <div class="spinner"></div>
            <p>Loading available symbols and date ranges...</p>
        </div>
        
        <form id="trainingForm">
            <!-- Symbol Selection -->
            <div class="section">
                <h2>üìä Trading Symbols</h2>
                <div class="form-group">
                    <label>Primary Symbols (Select one or more)</label>
                    <div id="symbolGrid" class="symbol-grid">
                        <!-- Populated dynamically -->
                    </div>
                    <div class="help-text">Select the symbols you want to trade</div>
                </div>
                
                <div class="form-group">
                    <label>Context Symbols (Optional)</label>
                    <div id="contextSymbolGrid" class="symbol-grid">
                        <!-- Populated dynamically -->
                    </div>
                    <div class="help-text">Add market context like QQQ, SPY, VIX for relative features</div>
                </div>
            </div>
            
            <!-- Date Range -->
            <div class="section">
                <h2>üìÖ Date Range</h2>
                <div class="two-col">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate" name="start_date" required>
                        <div class="help-text" id="startDateHelp">Earliest: Loading...</div>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate" name="end_date" required>
                        <div class="help-text" id="endDateHelp">Latest: Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Fold Configuration -->
            <div class="section">
                <h2>üîÑ Walk-Forward Fold Configuration</h2>
                <div class="two-col">
                    <div class="form-group">
                        <label for="trainMonths">Training Window (months)</label>
                        <input type="number" id="trainMonths" name="train_months" value="3" min="1" max="12">
                        <div class="help-text">How many months to use for training</div>
                    </div>
                    <div class="form-group">
                        <label for="testMonths">Test Window (months)</label>
                        <input type="number" id="testMonths" name="test_months" value="1" min="1" max="6">
                        <div class="help-text">How many months to use for testing</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="stepMonths">Step Size (months)</label>
                    <input type="number" id="stepMonths" name="step_months" value="1" min="1" max="6">
                    <div class="help-text">How many months to step forward for each new fold</div>
                </div>
            </div>
            
            <!-- Algorithm Selection -->
            <div class="section">
                <h2>ü§ñ Algorithm Selection</h2>
                <div class="algorithm-grid">
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="elasticnet" checked>
                        <div>
                            <strong>ElasticNet</strong>
                            <div class="help-text">L1+L2 regularization, good for linear patterns</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="ridge">
                        <div>
                            <strong>Ridge</strong>
                            <div class="help-text">L2 regularization only</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="lasso">
                        <div>
                            <strong>Lasso</strong>
                            <div class="help-text">L1 regularization, feature selection</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="randomforest">
                        <div>
                            <strong>Random Forest</strong>
                            <div class="help-text">Non-linear, ensemble method</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="xgboost">
                        <div>
                            <strong>XGBoost</strong>
                            <div class="help-text">Gradient boosting, high performance</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="lightgbm">
                        <div>
                            <strong>LightGBM</strong>
                            <div class="help-text">Fast gradient boosting, low memory</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Feature Configuration -->
            <div class="section">
                <h2>üìà Feature Configuration</h2>
                <div class="form-group">
                    <label for="windows">SMA/EMA Windows (comma-separated)</label>
                    <input type="text" id="windows" name="windows" value="50, 200" placeholder="e.g., 50, 100, 200">
                    <div class="help-text">Moving average window sizes (e.g., SMA-50, SMA-200)</div>
                </div>
                <div class="form-group">
                    <label for="resamplingTimeframes">Multi-Timeframe Resampling (comma-separated, optional)</label>
                    <input type="text" id="resamplingTimeframes" name="resampling_timeframes" value="" placeholder="e.g., 5min, 15min, 1H">
                    <div class="help-text">Leave empty to use only 1-min bars, or add higher timeframes for multi-scale features</div>
                </div>
            </div>
            
            <!-- Hyperparameter Tuning -->
            <div class="section">
                <h2>üéØ Hyperparameter Tuning</h2>
                <div class="two-col">
                    <div class="form-group">
                        <label for="numSamples">Number of Trials</label>
                        <input type="number" id="numSamples" name="num_samples" value="50" min="1" max="1000">
                        <div class="help-text">How many hyperparameter configurations to test</div>
                    </div>
                    <div class="form-group">
                        <label for="numGpus">GPUs per Trial</label>
                        <input type="number" id="numGpus" name="num_gpus" value="0" min="0" max="8" step="0.1">
                        <div class="help-text">Set to 1.0 for GPU acceleration (requires GPU instance)</div>
                    </div>
                </div>
                
                <!-- Error Handling Options -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="skipEmptyFolds" name="skip_empty_folds" style="margin-right: 8px;">
                        <span>Skip Empty Folds</span>
                    </label>
                    <div class="help-text">
                        If checked, training will skip folds with no data and continue with valid folds. 
                        If unchecked, training will fail immediately on empty folds (recommended for debugging).
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary" id="submitBtn">
                üöÄ Start Walk-Forward Training
            </button>
        </form>
        
        <!-- Backtesting Section -->
        <div class="section" style="margin-top: 30px;">
            <h2>üéØ Model Backtesting (VectorBT)</h2>
            <p class="help-text" style="margin-bottom: 20px;">
                Validate trained models with realistic trading simulation including fees and slippage
            </p>
            
            <div class="form-group">
                <label for="backtestExperiment">Select Trained Model</label>
                <select id="backtestExperiment" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em;">
                    <option value="">-- Loading available models... --</option>
                </select>
                <div class="help-text" id="modelInfoHelp">Select an experiment to view model details</div>
            </div>
            
            <div class="form-group">
                <label>Symbols to Backtest</label>
                <div id="backtestSymbolGrid" class="symbol-grid">
                    <!-- Populated dynamically -->
                </div>
                <div class="help-text">Select which symbols to test the model against (leave empty for all available)</div>
            </div>
            
            <div class="section" style="background: white; border-left: 4px solid #764ba2; margin: 20px 0;">
                <h3 style="font-size: 1.1em; margin-bottom: 15px;">Walk-Forward Configuration</h3>
                <div class="two-col">
                    <div class="form-group">
                        <label for="backtestTrainMonths">Training Window (months)</label>
                        <input type="number" id="backtestTrainMonths" value="3" min="1" max="12">
                        <div class="help-text">Months of training data per fold</div>
                    </div>
                    <div class="form-group">
                        <label for="backtestTestMonths">Test Window (months)</label>
                        <input type="number" id="backtestTestMonths" value="1" min="1" max="6">
                        <div class="help-text">Months of test data per fold</div>
                    </div>
                </div>
                <div class="two-col">
                    <div class="form-group">
                        <label for="backtestStepMonths">Step Size (months)</label>
                        <input type="number" id="backtestStepMonths" value="1" min="1" max="6">
                        <div class="help-text">Step forward increment</div>
                    </div>
                    <div class="form-group">
                        <label for="backtestStartDate">Start Date (optional)</label>
                        <input type="date" id="backtestStartDate">
                        <div class="help-text" id="backtestStartDateHelp">Auto-populated from symbol data</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="backtestEndDate">End Date (optional)</label>
                    <input type="date" id="backtestEndDate">
                    <div class="help-text" id="backtestEndDateHelp">Auto-populated from symbol data</div>
                </div>
            </div>
            
            <div class="two-col">
                <div class="form-group">
                    <label for="initialCapital">Initial Capital ($)</label>
                    <input type="number" id="initialCapital" value="100000" min="1000" step="1000">
                    <div class="help-text">Starting portfolio value</div>
                </div>
                <div class="form-group">
                    <label for="commission">Commission (%)</label>
                    <input type="number" id="commission" value="0.1" min="0" max="5" step="0.01">
                    <div class="help-text">Trading fees per transaction</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="slippage">Slippage (%)</label>
                <input type="number" id="slippage" value="0.05" min="0" max="5" step="0.01">
                <div class="help-text">Price impact of market orders</div>
            </div>
            
            <button type="button" class="btn btn-secondary" id="generateFoldsBtn" onclick="generateFoldsOnly()" style="width: 100%; margin-bottom: 10px; background: #FFA500;">
                üìÅ Generate Fold Data Only
            </button>
            
            <button type="button" class="btn btn-primary" id="backtestBtn" onclick="runBacktest()">
                üìä Run Backtest
            </button>
            
            <div id="backtestStatus" class="status"></div>
            
            <div id="backtestResults" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-bottom: 15px;">Backtest Results</h3>
                <div id="backtestResultsContent"></div>
            </div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="links">
            <h3 style="margin-bottom: 10px;">üìä Monitoring Links</h3>
            <a id="rayDashboardLink" href="#" target="_blank">Ray Dashboard</a>
            <a id="grafanaLink" href="#" target="_blank">Grafana</a>
            <a id="prometheusLink" href="#" target="_blank">Prometheus</a>
            <a href="/status" target="_blank">API Status</a>
        </div>
    </div>
    
    <script>
        let availableSymbols = [];
        let symbolDateRanges = {}; // Store per-symbol date ranges
        let dateRange = { start: null, end: null };
        
        // Detect environment and set monitoring links
        function setupMonitoringLinks() {
            const hostname = window.location.hostname;
            const isCodespaces = hostname.includes('.app.github.dev');
            
            if (isCodespaces) {
                // GitHub Codespaces pattern: cuddly-trout-v959vxxj7gc6p79-{PORT}.app.github.dev
                const baseUrl = hostname.replace(/-\d+\./, '-');  // Remove port
                document.getElementById('rayDashboardLink').href = `https://${baseUrl}8265.app.github.dev/`;
                document.getElementById('grafanaLink').href = `https://${baseUrl}3000.app.github.dev/`;
                document.getElementById('prometheusLink').href = `https://${baseUrl}9090.app.github.dev/`;
            } else {
                // Local development
                document.getElementById('rayDashboardLink').href = 'http://localhost:8265';
                document.getElementById('grafanaLink').href = 'http://localhost:3000';
                document.getElementById('prometheusLink').href = 'http://localhost:9090';
            }
        }
        
        // Initialize monitoring links on page load
        setupMonitoringLinks();
        
        // Load available symbols and date ranges
        async function loadData() {
            document.getElementById('loadingData').style.display = 'block';
            
            try {
                // Get streaming status to discover symbols
                const response = await fetch('/streaming/status');
                const data = await response.json();
                
                console.log('loadData - Streaming status:', data);
                
                if (data.data_sources && data.data_sources.symbols) {
                    // Extract symbols with date ranges
                    const symbols = data.data_sources.symbols;
                    const maxAllowedDate = data.data_sources.max_allowed_date; // Backend enforces Month-1
                    
                    availableSymbols = symbols.map(s => s.symbol).sort();
                    console.log('loadData - Available symbols:', availableSymbols);
                    
                    // Store per-symbol date ranges
                    symbols.forEach(s => {
                        // Strip 'dt=' prefix if present
                        const startDate = s.date_range.start.replace(/^dt=/, '');
                        const endDate = s.date_range.end.replace(/^dt=/, '');
                        
                        symbolDateRanges[s.symbol] = {
                            start: startDate,
                            end: endDate,
                            capped: s.date_range.capped || false  // Was end date capped?
                        };
                    });
                    
                    // Find overall date range across all symbols
                    if (symbols.length > 0) {
                        const allStarts = symbols.map(s => s.date_range.start.replace(/^dt=/, ''));
                        const allEnds = symbols.map(s => s.date_range.end.replace(/^dt=/, ''));
                        
                        dateRange.start = allStarts.reduce((min, d) => !min || d < min ? d : min, null);
                        dateRange.end = allEnds.reduce((max, d) => !max || d > max ? d : max, null);
                    }
                }
                
                // Fallback to reasonable defaults if no data
                if (!dateRange.start || !dateRange.end) {
                    const today = new Date();
                    const sixMonthsAgo = new Date(today);
                    sixMonthsAgo.setMonth(today.getMonth() - 6);
                    
                    dateRange.start = sixMonthsAgo.toISOString().split('T')[0];
                    dateRange.end = today.toISOString().split('T')[0];
                }
                
                populateSymbols();
                
                // Auto-select first symbol and set its date range as default
                if (availableSymbols.length > 0) {
                    const firstSymbol = availableSymbols[0];
                    const firstCheckbox = document.getElementById(`sym_${firstSymbol}`);
                    if (firstCheckbox) {
                        firstCheckbox.checked = true;
                        // Manually trigger the date update
                        if (symbolDateRanges[firstSymbol]) {
                            const range = symbolDateRanges[firstSymbol];
                            console.log('Setting dates for', firstSymbol, range);
                            
                            const startInput = document.getElementById('startDate');
                            const endInput = document.getElementById('endDate');
                            
                            if (startInput && endInput) {
                                startInput.value = range.start;
                                endInput.value = range.end;
                                
                                startInput.min = dateRange.start;
                                startInput.max = dateRange.end;
                                endInput.min = dateRange.start;
                                endInput.max = dateRange.end;
                                
                                console.log('Date inputs set:', startInput.value, endInput.value);
                                
                                // Show capped warning if applicable
                                const cappedWarning = range.capped ? ' ‚ö†Ô∏è (capped to previous month)' : '';
                                
                                document.getElementById('startDateHelp').textContent = 
                                    `${firstSymbol}: ${range.start} (Overall: ${dateRange.start})`;
                                document.getElementById('endDateHelp').textContent = 
                                    `${firstSymbol}: ${range.end}${cappedWarning} (Overall: ${dateRange.end})`;
                            } else {
                                console.error('Date inputs not found!');
                            }
                        }
                    }
                } else {
                    populateDates();
                }
                
                // Update API examples after data is loaded
                setTimeout(updateApiExamples, 100);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showStatus('error', 'Failed to load symbols. Please check if data is available.');
            } finally {
                document.getElementById('loadingData').style.display = 'none';
            }
        }
        
        function populateSymbols() {
            const symbolGrid = document.getElementById('symbolGrid');
            const contextGrid = document.getElementById('contextSymbolGrid');
            const backtestGrid = document.getElementById('backtestSymbolGrid');
            
            console.log('populateSymbols - symbolGrid:', symbolGrid, 'contextGrid:', contextGrid, 'backtestGrid:', backtestGrid);
            console.log('populateSymbols - availableSymbols:', availableSymbols);
            
            // Use available symbols from parquet data
            const allSymbols = availableSymbols.length > 0 ? availableSymbols : ['AAPL', 'MSFT', 'GOOGL'];
            
            console.log('populateSymbols - allSymbols:', allSymbols);
            
            // Populate primary symbols - use all available symbols
            allSymbols.forEach(symbol => {
                const div = document.createElement('div');
                div.className = 'symbol-item';
                div.innerHTML = `
                    <input type="checkbox" id="sym_${symbol}" value="${symbol}">
                    <label for="sym_${symbol}">${symbol}</label>
                `;
                symbolGrid.appendChild(div);
                
                // Add event listener to update dates when symbol is selected
                const checkbox = div.querySelector('input');
                checkbox.addEventListener('change', () => {
                    updateDatesFromSelectedSymbol();
                    updateApiExamples();
                });
            });
            
            // Populate context symbols - use same list (all available symbols)
            allSymbols.forEach(symbol => {
                const div = document.createElement('div');
                div.className = 'symbol-item';
                div.innerHTML = `
                    <input type="checkbox" id="ctx_${symbol}" value="${symbol}">
                    <label for="ctx_${symbol}">${symbol}</label>
                `;
                contextGrid.appendChild(div);
                
                // Update API examples when context symbols change too
                const checkbox = div.querySelector('input');
                checkbox.addEventListener('change', updateApiExamples);
            });
            
            // Populate backtest symbols
            allSymbols.forEach(symbol => {
                const div = document.createElement('div');
                div.className = 'symbol-item';
                div.innerHTML = `
                    <input type="checkbox" id="btest_${symbol}" value="${symbol}">
                    <label for="btest_${symbol}">${symbol}</label>
                `;
                backtestGrid.appendChild(div);
                
                // Update API examples and dates when backtest symbols change
                const checkbox = div.querySelector('input');
                checkbox.addEventListener('change', () => {
                    populateBacktestDates();
                    updateApiExamples();
                });
            });
        }
        
        function updateDatesFromSelectedSymbol() {
            // Get the first selected primary symbol
            const selectedSymbols = Array.from(document.querySelectorAll('#symbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedSymbols.length === 0) {
                // No symbols selected, use overall range
                populateDates();
                return;
            }
            
            // Use the date range of the first selected symbol as the primary target
            const primarySymbol = selectedSymbols[0];
            if (symbolDateRanges[primarySymbol]) {
                const range = symbolDateRanges[primarySymbol];
                const startInput = document.getElementById('startDate');
                const endInput = document.getElementById('endDate');
                
                startInput.value = range.start;
                endInput.value = range.end;
                
                // Still allow full range adjustment
                startInput.min = dateRange.start;
                startInput.max = dateRange.end;
                endInput.min = dateRange.start;
                endInput.max = dateRange.end;
                
                document.getElementById('startDateHelp').textContent = 
                    `${primarySymbol}: ${range.start} (Overall: ${dateRange.start})`;
                document.getElementById('endDateHelp').textContent = 
                    `${primarySymbol}: ${range.end} (Overall: ${dateRange.end})`;
            } else {
                populateDates();
            }
        }
        
        function populateDates() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            startInput.value = dateRange.start;
            endInput.value = dateRange.end;
            
            startInput.min = dateRange.start;
            startInput.max = dateRange.end;
            endInput.min = dateRange.start;
            endInput.max = dateRange.end;
            
            document.getElementById('startDateHelp').textContent = `Earliest: ${dateRange.start}`;
            document.getElementById('endDateHelp').textContent = `Latest: ${dateRange.end}`;
        }
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        // Form submission
        document.getElementById('trainingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Starting Training...';
            
            // Collect selected symbols
            const symbols = Array.from(document.querySelectorAll('#symbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            const contextSymbols = Array.from(document.querySelectorAll('#contextSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (symbols.length === 0) {
                showStatus('error', 'Please select at least one primary symbol');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Start Walk-Forward Training';
                return;
            }
            
            // Parse windows
            const windows = document.getElementById('windows').value
                .split(',')
                .map(w => parseInt(w.trim()))
                .filter(w => !isNaN(w));
            
            // Parse resampling timeframes
            const resamplingInput = document.getElementById('resamplingTimeframes').value.trim();
            const resamplingTimeframes = resamplingInput
                ? resamplingInput.split(',').map(t => t.trim())
                : null;
            
            // Build request payload
            const payload = {
                symbols: symbols,
                context_symbols: contextSymbols.length > 0 ? contextSymbols : null,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                train_months: parseInt(document.getElementById('trainMonths').value),
                test_months: parseInt(document.getElementById('testMonths').value),
                step_months: parseInt(document.getElementById('stepMonths').value),
                algorithm: document.querySelector('input[name="algorithm"]:checked').value,
                num_samples: parseInt(document.getElementById('numSamples').value),
                num_gpus: parseFloat(document.getElementById('numGpus').value),
                skip_empty_folds: document.getElementById('skipEmptyFolds').checked,
                windows: windows,
                resampling_timeframes: resamplingTimeframes
            };
            
            try {
                const response = await fetch('/train/walk_forward', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const rayDashboardUrl = document.getElementById('rayDashboardLink').href;
                    showStatus('success', 
                        `Training started! ${result.num_samples} trials across ${symbols.join(', ')}. ` +
                        `Check Ray Dashboard for progress: ${rayDashboardUrl}`
                    );
                } else {
                    showStatus('error', `Failed to start training: ${result.detail || 'Unknown error'}`);
                }
            } catch (error) {
                showStatus('error', `Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Start Walk-Forward Training';
            }
        });
        
        // Load data on page load
        loadData();
        loadAvailableModels();
        
        // ============================================================================
        // Model Selection Functions
        // ============================================================================
        
        let availableModels = [];
        
        async function loadAvailableModels() {
            try {
                const response = await fetch('/backtest/experiments');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                console.log('Loaded models:', data);
                availableModels = data.experiments || [];
                populateModelDropdown();
                
            } catch (error) {
                console.error('Error loading models:', error);
                const select = document.getElementById('backtestExperiment');
                if (select) {
                    select.innerHTML = '<option value="">-- Error loading models --</option>';
                }
            }
        }
        
        function populateModelDropdown() {
            const select = document.getElementById('backtestExperiment');
            if (!select) return;
            
            if (availableModels.length === 0) {
                select.innerHTML = '<option value="">-- No trained models available --</option>';
                return;
            }
            
            // Sort models by name
            availableModels.sort((a, b) => a.name.localeCompare(b.name));
            
            // Build options
            let html = '<option value="">-- Select a model --</option>';
            availableModels.forEach(model => {
                const info = model.model_info;
                let optionText = model.name;
                
                if (info) {
                    const rmse = info.test_rmse ? info.test_rmse.toFixed(6) : 'N/A';
                    const r2 = info.test_r2 ? info.test_r2.toFixed(4) : 'N/A';
                    optionText += ` (RMSE: ${rmse}, R¬≤: ${r2})`;
                }
                
                html += `<option value="${model.name}">${optionText}</option>`;
            });
            
            select.innerHTML = html;
            
            // Add change listener to show model details (which triggers API update)
            select.addEventListener('change', showModelDetails);
        }
        
        function showModelDetails() {
            const select = document.getElementById('backtestExperiment');
            const helpText = document.getElementById('modelInfoHelp');
            
            if (!select || !helpText) return;
            
            const selectedName = select.value;
            if (!selectedName) {
                helpText.textContent = 'Select an experiment to view model details';
                populateBacktestDates(null);  // Clear dates
                return;
            }
            
            const model = availableModels.find(m => m.name === selectedName);
            if (!model || !model.model_info) {
                helpText.textContent = 'Model details unavailable';
                populateBacktestDates(null);  // Clear dates
                return;
            }
            
            const info = model.model_info;
            helpText.innerHTML = `
                <strong>Model Details:</strong> 
                Trial: ${info.trial_id || 'N/A'} | 
                RMSE: ${info.test_rmse ? info.test_rmse.toFixed(6) : 'N/A'} | 
                R¬≤: ${info.test_r2 ? info.test_r2.toFixed(4) : 'N/A'} | 
                Path: ${model.path}
            `;
            
            // Trigger API example update
            updateApiExamples();
        }
        
        function populateBacktestDates() {
            const startInput = document.getElementById('backtestStartDate');
            const endInput = document.getElementById('backtestEndDate');
            const startHelp = document.getElementById('backtestStartDateHelp');
            const endHelp = document.getElementById('backtestEndDateHelp');
            
            if (!startInput || !endInput) return;
            
            // Get selected symbols from backtest grid
            const selectedSymbols = Array.from(document.querySelectorAll('#backtestSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedSymbols.length === 0) {
                // Clear if no symbols selected
                startInput.value = '';
                endInput.value = '';
                startInput.removeAttribute('min');
                startInput.removeAttribute('max');
                endInput.removeAttribute('min');
                endInput.removeAttribute('max');
                
                if (startHelp) startHelp.textContent = 'Select symbols to auto-populate';
                if (endHelp) endHelp.textContent = 'Select symbols to auto-populate';
                return;
            }
            
            // Compute overall date range across selected symbols
            let overallStart = null;
            let overallEnd = null;
            
            selectedSymbols.forEach(symbol => {
                if (symbolDateRanges[symbol]) {
                    const range = symbolDateRanges[symbol];
                    
                    if (!overallStart || range.start < overallStart) {
                        overallStart = range.start;
                    }
                    if (!overallEnd || range.end > overallEnd) {
                        overallEnd = range.end;
                    }
                }
            });
            
            if (!overallStart || !overallEnd) {
                if (startHelp) startHelp.textContent = 'No data available for selected symbols';
                if (endHelp) endHelp.textContent = 'No data available for selected symbols';
                return;
            }
            
            // Set values to overall date range
            startInput.value = overallStart;
            endInput.value = overallEnd;
            
            // Set min/max constraints
            startInput.min = overallStart;
            startInput.max = overallEnd;
            endInput.min = overallStart;
            endInput.max = overallEnd;
            
            // Update help text with symbol count
            const symbolList = selectedSymbols.length <= 3 ? selectedSymbols.join(', ') : `${selectedSymbols.length} symbols`;
            if (startHelp) startHelp.textContent = `${symbolList}: Earliest ${overallStart}`;
            if (endHelp) endHelp.textContent = `${symbolList}: Latest ${overallEnd}`;
            
            console.log(`Auto-populated backtest dates for ${selectedSymbols.join(', ')}: ${overallStart} to ${overallEnd}`);
        }
        
        // ============================================================================
        // Backtesting Functions
        // ============================================================================
        
        async function generateFoldsOnly() {
            const btn = document.getElementById('generateFoldsBtn');
            
            // Get selected symbols from backtest grid
            const selectedSymbols = Array.from(document.querySelectorAll('#backtestSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedSymbols.length === 0) {
                showBacktestStatus('error', 'Please select at least one symbol in "Symbols to Backtest"');
                return;
            }
            
            if (selectedSymbols.length > 1) {
                showBacktestStatus('error', 'Please select only ONE symbol at a time for fold generation');
                return;
            }
            
            const symbol = selectedSymbols[0];
            
            // Get dates
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            
            if (!startDate || !endDate) {
                showBacktestStatus('error', 'Please select start and end dates (auto-populated from symbol data)');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating Folds...';
            showBacktestStatus('info', `Generating fold data for ${symbol}...`);
            
            const payload = {
                symbol: symbol,
                start_date: startDate,
                end_date: endDate,
                train_months: parseInt(document.getElementById('backtestTrainMonths').value),
                test_months: parseInt(document.getElementById('backtestTestMonths').value),
                step_months: parseInt(document.getElementById('backtestStepMonths').value)
            };
            
            try {
                const response = await fetch('/streaming/generate-folds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showBacktestStatus('success', 
                        `‚úÖ Fold generation started for ${symbol}! ` +
                        `Train: ${result.fold_config.train_months}mo, Test: ${result.fold_config.test_months}mo, Step: ${result.fold_config.step_months}mo. ` +
                        `Check logs for progress. Output: ${result.output_path}/fold_*/`
                    );
                } else {
                    showBacktestStatus('error', `Fold generation failed: ${result.detail || 'Unknown error'}`);
                }
                
            } catch (error) {
                showBacktestStatus('error', `Network error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìÅ Generate Fold Data Only';
            }
        }
        
        async function runBacktest() {
            const backtestBtn = document.getElementById('backtestBtn');
            const select = document.getElementById('backtestExperiment');
            const experimentName = select ? select.value : '';
            
            if (!experimentName) {
                showBacktestStatus('error', 'Please select a trained model');
                return;
            }
            
            // Get selected symbols
            const symbols = Array.from(document.querySelectorAll('#backtestSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            backtestBtn.disabled = true;
            backtestBtn.textContent = '‚è≥ Running Backtest...';
            showBacktestStatus('info', 'Starting backtest simulation...');
            
            const payload = {
                experiment_name: experimentName,
                symbols: symbols.length > 0 ? symbols : null,  // null means use all available
                train_months: parseInt(document.getElementById('backtestTrainMonths').value),
                test_months: parseInt(document.getElementById('backtestTestMonths').value),
                step_months: parseInt(document.getElementById('backtestStepMonths').value),
                start_date: document.getElementById('backtestStartDate').value || null,
                end_date: document.getElementById('backtestEndDate').value || null,
                initial_capital: parseFloat(document.getElementById('initialCapital').value),
                commission: parseFloat(document.getElementById('commission').value) / 100,  // Convert % to decimal
                slippage: parseFloat(document.getElementById('slippage').value) / 100  // Convert % to decimal
            };
            
            try {
                const response = await fetch('/backtest/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showBacktestStatus('success', 'Backtest completed successfully!');
                    displayBacktestResults(result);
                } else {
                    showBacktestStatus('error', `Backtest failed: ${result.detail || 'Unknown error'}`);
                }
            } catch (error) {
                showBacktestStatus('error', `Error: ${error.message}`);
            } finally {
                backtestBtn.disabled = false;
                backtestBtn.textContent = 'üìä Run Backtest';
            }
        }
        
        function showBacktestStatus(type, message) {
            const statusDiv = document.getElementById('backtestStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        function displayBacktestResults(result) {
            const resultsDiv = document.getElementById('backtestResults');
            const contentDiv = document.getElementById('backtestResultsContent');
            
            const summary = result.results;
            
            // Create assessment badge
            const assessmentColors = {
                'EXCELLENT': 'üü¢',
                'GOOD': 'üü°',
                'MARGINAL': 'üü†',
                'POOR': 'üî¥'
            };
            const badge = assessmentColors[summary.assessment] || '‚ö™';
            
            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: white; border-radius: 6px; border-left: 4px solid #667eea;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Assessment</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${badge} ${summary.assessment}</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Return</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: ${summary.avg_total_return >= 0 ? '#28a745' : '#dc3545'};">
                            ${(summary.avg_total_return * 100).toFixed(2)}%
                        </div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Sharpe Ratio</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${summary.avg_sharpe_ratio.toFixed(3)}</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Max Drawdown</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">
                            ${(summary.avg_max_drawdown * 100).toFixed(2)}%
                        </div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Win Rate</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${(summary.avg_win_rate * 100).toFixed(1)}%</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Trades</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${summary.avg_num_trades.toFixed(0)}</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Return Consistency</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${summary.return_consistency.toFixed(3)}</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">vs Buy & Hold</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: ${summary.avg_alpha >= 0 ? '#28a745' : '#dc3545'};">
                            ${summary.avg_alpha >= 0 ? '+' : ''}${(summary.avg_alpha * 100).toFixed(2)}%
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">
                    <strong>Model Info:</strong><br>
                    Trial: ${result.model_info.trial_id}<br>
                    RMSE: ${result.model_info.test_rmse.toFixed(6)}<br>
                    R¬≤: ${result.model_info.test_r2.toFixed(4)}
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }
        
        // ============================================================================
        // API Sidebar Functions
        // ============================================================================
        
        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        }
        
        function copyCurl(btn) {
            const codeSpan = btn.nextElementSibling;
            const text = codeSpan.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.classList.add('copied');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                btn.textContent = '‚úó Failed';
                setTimeout(() => {
                    btn.textContent = 'Copy';
                }, 2000);
            });
        }
        
        function updateApiExamples() {
            // Get form values
            const symbols = Array.from(document.querySelectorAll('#symbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const startDate = document.getElementById('startDate')?.value || '';
            const endDate = document.getElementById('endDate')?.value || '';
            
            // Get selected algorithm from radio buttons
            const algorithmRadio = document.querySelector('input[name="algorithm"]:checked');
            const modelType = algorithmRadio ? algorithmRadio.value : 'xgboost';
            
            const numSamplesInput = document.getElementById('numSamples');
            const numSamples = numSamplesInput ? numSamplesInput.value : '50';
            const timeframe = '1m';
            
            // Get backtesting parameters
            const backtestSymbols = Array.from(document.querySelectorAll('#backtestSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const backtestSelect = document.getElementById('backtestExperiment');
            const backtestExperiment = backtestSelect ? backtestSelect.value : '';
            const initialCapital = parseFloat(document.getElementById('initialCapital')?.value || 100000);
            const commission = parseFloat(document.getElementById('commission')?.value || 0.1) / 100;
            const slippage = parseFloat(document.getElementById('slippage')?.value || 0.05) / 100;
            const backtestTrainMonths = parseInt(document.getElementById('backtestTrainMonths')?.value || 3);
            const backtestTestMonths = parseInt(document.getElementById('backtestTestMonths')?.value || 1);
            const backtestStepMonths = parseInt(document.getElementById('backtestStepMonths')?.value || 1);
            const backtestStartDate = document.getElementById('backtestStartDate')?.value || null;
            const backtestEndDate = document.getElementById('backtestEndDate')?.value || null;
            
            // Generate experiment name
            const primarySymbol = symbols.length > 0 ? symbols[0] : 'GOOGL';
            const experimentName = backtestExperiment || `walk_forward_${modelType}_${primarySymbol}`;
            
            // Debug log
            console.log('Updating API examples:', { symbols, startDate, endDate, modelType, numSamples, experimentName });
            
            // Add visual feedback
            const curlExamples = document.querySelectorAll('.curl-example');
            curlExamples.forEach(elem => elem.classList.add('updating'));
            setTimeout(() => {
                curlExamples.forEach(elem => elem.classList.remove('updating'));
            }, 300);
            
            // Update Training curl
            const trainPayload = {
                symbols: symbols.length > 0 ? symbols : ['GOOGL'],
                model_type: modelType,
                start_date: startDate || '2024-01-01',
                end_date: endDate || '2024-12-31',
                num_samples: parseInt(numSamples) || 50
            };
            
            const trainElem = document.getElementById('trainCurl');
            if (trainElem) {
                trainElem.textContent = 
`curl -X POST http://localhost:8265/train/walk-forward \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(trainPayload, null, 2)}'`;
            }
            
            // Update Folds curl (extracts symbol from model selection)
            // backtestSelect already declared above
            const selectedModel = backtestSelect ? backtestSelect.value : '';
            let foldSymbol = 'AAPL';  // Default
            
            if (selectedModel) {
                // Extract symbol from model name (e.g., "walk_forward_xgboost_AAPL" -> "AAPL")
                const parts = selectedModel.split('_');
                if (parts.length >= 3) {
                    foldSymbol = parts[parts.length - 1];
                }
            }
            
            const foldsPayload = {
                symbol: foldSymbol,
                start_date: backtestStartDate || startDate || '2020-01-01',
                end_date: backtestEndDate || endDate || '2024-12-31',
                train_months: backtestTrainMonths,
                test_months: backtestTestMonths,
                step_months: backtestStepMonths
            };
            
            const foldsElem = document.getElementById('foldsCurl');
            if (foldsElem) {
                foldsElem.textContent = 
`curl -X POST http://localhost:8265/streaming/generate-folds \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(foldsPayload, null, 2)}'`;
            }
            
            // Update Backtest curl
            const backtestPayload = {
                experiment_name: experimentName,
                symbols: backtestSymbols.length > 0 ? backtestSymbols : null,
                train_months: backtestTrainMonths,
                test_months: backtestTestMonths,
                step_months: backtestStepMonths,
                start_date: backtestStartDate,
                end_date: backtestEndDate,
                initial_capital: initialCapital,
                commission: commission,
                slippage: slippage
            };
            
            const backtestElem = document.getElementById('backtestCurl');
            if (backtestElem) {
                backtestElem.textContent = 
`curl -X POST http://localhost:8265/backtest/validate \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(backtestPayload, null, 2)}'`;
            }
            
            // Update Results curl
            const resultsElem = document.getElementById('resultsCurl');
            if (resultsElem) {
                resultsElem.textContent = 
`curl -X GET http://localhost:8265/backtest/results/${experimentName}`;
            }
        }
        
        // Update API examples whenever form changes
        document.addEventListener('DOMContentLoaded', () => {
            // Add listeners to all form elements for real-time updates
            const addUpdateListener = (id) => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.addEventListener('change', updateApiExamples);
                    elem.addEventListener('input', updateApiExamples);
                }
            };
            
            // Listen to all key form inputs
            addUpdateListener('startDate');
            addUpdateListener('endDate');
            addUpdateListener('numSamples');
            addUpdateListener('trainMonths');
            addUpdateListener('testMonths');
            addUpdateListener('stepMonths');
            addUpdateListener('skipEmptyFolds');
            addUpdateListener('windows');
            addUpdateListener('resamplingTimeframes');
            
            // Listen to algorithm radio buttons
            const algorithmRadios = document.querySelectorAll('input[name="algorithm"]');
            algorithmRadios.forEach(radio => {
                radio.addEventListener('change', updateApiExamples);
            });
            
            // Listen to backtesting parameters
            addUpdateListener('backtestExperiment');
            addUpdateListener('initialCapital');
            addUpdateListener('commission');
            addUpdateListener('slippage');
            addUpdateListener('backtestTrainMonths');
            addUpdateListener('backtestTestMonths');
            addUpdateListener('backtestStepMonths');
            addUpdateListener('backtestStartDate');
            addUpdateListener('backtestEndDate');
        });
    </script>
</body>
</html>
