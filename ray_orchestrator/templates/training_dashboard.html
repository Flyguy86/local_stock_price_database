<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ray Orchestrator - Walk-Forward Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .sidebar {
            display: none;
            position: fixed;
            right: 20px;
            top: 20px;
            width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar.visible {
            display: block;
        }
        
        .sidebar h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .api-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .api-section h3 {
            color: #555;
            font-size: 1em;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .api-section h3:hover {
            color: #667eea;
        }
        
        .api-section h3::before {
            content: '‚ñº ';
            font-size: 0.8em;
            transition: transform 0.3s;
            display: inline-block;
        }
        
        .api-section h3.collapsed::before {
            transform: rotate(-90deg);
        }
        
        .curl-example {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 10px;
            position: relative;
            transition: box-shadow 0.3s ease;
        }
        
        .curl-example.updating {
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }
        
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .copy-btn:hover {
            background: #5568d3;
        }
        
        .copy-btn.copied {
            background: #28a745;
        }
        
        .api-toggle-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .api-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
        }
        
        .api-toggle-btn:active {
            transform: scale(0.95);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        .help-text {
            font-size: 0.85em;
            color: #888;
            margin-top: 4px;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        
        .symbol-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .symbol-item:hover {
            background: #e9ecef;
        }
        
        .symbol-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .algorithm-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .algorithm-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .algorithm-item:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        
        .algorithm-item input[type="radio"] {
            margin-right: 8px;
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .windows-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .windows-input input {
            flex: 1;
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .retrain-step {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #modelListTable tr:hover {
            background: #f8f9fa !important;
        }
        
        .feature-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        #featureTableBody tr:hover {
            background: #f0f7ff !important;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .links {
            margin-top: 30px;
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
        }
        
        .links a {
            display: inline-block;
            margin-right: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Floating API Reference Toggle Button -->
    <button class="api-toggle-btn" onclick="toggleSidebar()" title="Toggle API Reference">
        üîå
    </button>
    
    <!-- API Reference Sidebar -->
    <div class="sidebar">
        <h2 onclick="toggleSidebar(this)" style="cursor: pointer; user-select: none;">üîå API Reference (Click to expand)</h2>
        <div class="sidebar-content" style="display: none;">
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Start Training</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="trainCurl">curl -X POST http://localhost:8265/train/walk-forward \
  -H "Content-Type: application/json" \
  -d '{
    "symbols": ["GOOGL"],
    "model_type": "xgboost",
    "start_date": "2024-01-01",
    "end_date": "2024-12-31",
    "num_samples": 50
  }'</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Generate Folds</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="foldsCurl">curl -X POST http://localhost:8265/streaming/generate-folds \
  -H "Content-Type: application/json" \
  -d '{
    "symbol": "<span class="param-symbol">AAPL</span>",
    "start_date": "<span class="param-start-date">2020-01-01</span>",
    "end_date": "<span class="param-end-date">2024-12-31</span>",
    "train_months": <span class="param-train-months">12</span>,
    "test_months": <span class="param-test-months">3</span>,
    "step_months": <span class="param-step-months">3</span>
  }'</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Backtest Model</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="backtestCurl">curl -X POST http://localhost:8265/backtest/validate \
  -H "Content-Type: application/json" \
  -d '{
    "experiment_name": "walk_forward_xgboost_GOOGL",
    "initial_capital": 100000.0,
    "commission": 0.001,
    "slippage": 0.0005
  }'</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Get Backtest Results</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="resultsCurl">curl -X GET http://localhost:8265/backtest/results/walk_forward_xgboost_GOOGL</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">List Experiments</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="experimentsCurl">curl -X GET http://localhost:8265/backtest/experiments</span>
            </div>
        </div>
        
        <div class="api-section">
            <h3 onclick="toggleSection(this)">Check Status</h3>
            <div class="curl-example">
                <button class="copy-btn" onclick="copyCurl(this)">Copy</button>
<span id="statusCurl">curl -X GET http://localhost:8265/streaming/status</span>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 8px;">
            <h3 style="font-size: 0.9em; color: #666; margin-bottom: 10px;">üí° Quick Tips</h3>
            <ul style="font-size: 0.85em; color: #666; margin-left: 20px;">
                <li>Curl examples update as you fill the form</li>
                <li>Click headers to collapse sections</li>
                <li>Use Copy button for easy clipboard access</li>
                <li>Port 8265 is Ray Dashboard default</li>
            </ul>
        </div>
        </div> <!-- Close sidebar-content -->
    </div>
    
    <div class="container">
        <!-- Tabbed Navigation -->
        <div style="
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0;
            overflow: hidden;
        ">
            <div style="display: flex; border-bottom: 2px solid #e5e7eb;">
                <div style="
                    flex: 1;
                    padding: 20px 30px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    font-weight: 600;
                    font-size: 1.1em;
                    border-bottom: 3px solid #667eea;
                    cursor: default;
                ">
                    üöÄ Training Dashboard
                </div>
                <a href="/registry" style="
                    flex: 1;
                    padding: 20px 30px;
                    background: white;
                    color: #666;
                    font-weight: 600;
                    font-size: 1.1em;
                    text-decoration: none;
                    text-align: center;
                    transition: all 0.3s;
                    border-bottom: 3px solid transparent;
                " onmouseover="
                    this.style.background='#f3f4f6';
                    this.style.color='#667eea';
                    this.style.borderBottomColor='#667eea';
                " onmouseout="
                    this.style.background='white';
                    this.style.color='#666';
                    this.style.borderBottomColor='transparent';
                ">
                    üóÑÔ∏è Model Registry
                </a>
                <a href="/backtest/dashboard" style="
                    flex: 1;
                    padding: 20px 30px;
                    background: white;
                    color: #666;
                    font-weight: 600;
                    font-size: 1.1em;
                    text-decoration: none;
                    text-align: center;
                    transition: all 0.3s;
                    border-bottom: 3px solid transparent;
                " onmouseover="
                    this.style.background='#f3f4f6';
                    this.style.color='#667eea';
                    this.style.borderBottomColor='#667eea';
                " onmouseout="
                    this.style.background='white';
                    this.style.color='#666';
                    this.style.borderBottomColor='transparent';
                ">
                    üìä VectorBT Dashboard
                </a>
                <a href="/backtest/results_viewer" style="
                    flex: 1;
                    padding: 20px 30px;
                    background: white;
                    color: #666;
                    font-weight: 600;
                    font-size: 1.1em;
                    text-decoration: none;
                    text-align: center;
                    transition: all 0.3s;
                    border-bottom: 3px solid transparent;
                " onmouseover="
                    this.style.background='#f3f4f6';
                    this.style.color='#667eea';
                    this.style.borderBottomColor='#667eea';
                " onmouseout="
                    this.style.background='white';
                    this.style.color='#666';
                    this.style.borderBottomColor='transparent';
                ">
                    üìà Results Viewer
                </a>
            </div>
        </div>
        
        <div style="
            background: white;
            padding: 20px 30px 10px;
            border-radius: 0 0 12px 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        ">
            <h1 style="margin: 0; font-size: 1.8em; color: #333;">Walk-Forward Training</h1>
            <p class="subtitle" style="margin: 10px 0 0;">Configure and launch ML training with proper walk-forward validation</p>
        </div>
        
        <div id="loadingData" class="loading">
            <div class="spinner"></div>
            <p>Loading available symbols and date ranges...</p>
        </div>
        
        <form id="trainingForm">
            <!-- Symbol Selection -->
            <div class="section">
                <h2>üìä Trading Symbols</h2>
                <div class="form-group">
                    <label>Primary Symbols (Select one or more)</label>
                    <div id="symbolGrid" class="symbol-grid">
                        <!-- Populated dynamically -->
                    </div>
                    <div class="help-text">Select the symbols you want to trade</div>
                </div>
                
                <div class="form-group">
                    <label>Context Symbols (Optional)</label>
                    <div id="contextSymbolGrid" class="symbol-grid">
                        <!-- Populated dynamically -->
                    </div>
                    <div class="help-text">Add market context like QQQ, SPY, VIX for relative features</div>
                </div>
            </div>
            
            <!-- Date Range -->
            <div class="section">
                <h2>üìÖ Date Range</h2>
                <div class="two-col">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate" name="start_date" required>
                        <div class="help-text" id="startDateHelp">Earliest: Loading...</div>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate" name="end_date" required>
                        <div class="help-text" id="endDateHelp">Latest: Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Fold Configuration -->
            <div class="section">
                <h2>üîÑ Walk-Forward Fold Configuration</h2>
                <div class="two-col">
                    <div class="form-group">
                        <label for="trainMonths">Training Window (months)</label>
                        <input type="number" id="trainMonths" name="train_months" value="3" min="1" max="12">
                        <div class="help-text">How many months to use for training</div>
                    </div>
                    <div class="form-group">
                        <label for="testMonths">Test Window (months)</label>
                        <input type="number" id="testMonths" name="test_months" value="1" min="1" max="6">
                        <div class="help-text">How many months to use for testing</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="stepMonths">Step Size (months)</label>
                    <input type="number" id="stepMonths" name="step_months" value="1" min="1" max="6">
                    <div class="help-text">How many months to step forward for each new fold</div>
                </div>
            </div>
            
            <!-- Algorithm Selection -->
            <div class="section">
                <h2>ü§ñ Algorithm Selection</h2>
                <div class="algorithm-grid">
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="elasticnet" checked>
                        <div>
                            <strong>ElasticNet</strong>
                            <div class="help-text">L1+L2 regularization, good for linear patterns</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="ridge">
                        <div>
                            <strong>Ridge</strong>
                            <div class="help-text">L2 regularization only</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="lasso">
                        <div>
                            <strong>Lasso</strong>
                            <div class="help-text">L1 regularization, feature selection</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="randomforest">
                        <div>
                            <strong>Random Forest</strong>
                            <div class="help-text">Non-linear, ensemble method</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="xgboost">
                        <div>
                            <strong>XGBoost</strong>
                            <div class="help-text">Gradient boosting, high performance</div>
                        </div>
                    </label>
                    <label class="algorithm-item">
                        <input type="radio" name="algorithm" value="lightgbm">
                        <div>
                            <strong>LightGBM</strong>
                            <div class="help-text">Fast gradient boosting, low memory</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Feature Configuration -->
            <div class="section">
                <h2>üìà Feature Configuration</h2>
                <div class="form-group">
                    <label for="windows">SMA/EMA Windows (comma-separated)</label>
                    <input type="text" id="windows" name="windows" value="50, 200" placeholder="e.g., 50, 100, 200">
                    <div class="help-text">Moving average window sizes (e.g., SMA-50, SMA-200)</div>
                </div>
                <div class="form-group">
                    <label for="resamplingTimeframes">Multi-Timeframe Resampling (comma-separated, optional)</label>
                    <input type="text" id="resamplingTimeframes" name="resampling_timeframes" value="" placeholder="e.g., 5min, 15min, 1H">
                    <div class="help-text">Leave empty to use only 1-min bars, or add higher timeframes for multi-scale features</div>
                </div>
            </div>
            
            <!-- Hyperparameter Tuning -->
            <div class="section">
                <h2>üéØ Hyperparameter Tuning</h2>
                <div class="two-col">
                    <div class="form-group">
                        <label for="numSamples">Number of Trials</label>
                        <input type="number" id="numSamples" name="num_samples" value="50" min="1" max="1000">
                        <div class="help-text">How many hyperparameter configurations to test</div>
                    </div>
                    <div class="form-group">
                        <label for="numGpus">GPUs per Trial</label>
                        <input type="number" id="numGpus" name="num_gpus" value="0" min="0" max="8" step="0.1">
                        <div class="help-text">Set to 1.0 for GPU acceleration (requires GPU instance)</div>
                    </div>
                </div>
                
                <!-- Error Handling Options -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="skipEmptyFolds" name="skip_empty_folds" style="margin-right: 8px;">
                        <span>Skip Empty Folds</span>
                    </label>
                    <div class="help-text">
                        If checked, training will skip folds with no data and continue with valid folds. 
                        If unchecked, training will fail immediately on empty folds (recommended for debugging).
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary" id="submitBtn">
                üöÄ Start Walk-Forward Training
            </button>
            
            <!-- Retrain Button -->
            <button type="button" class="btn" onclick="showRetrainWorkflow()" style="background: #28a745; margin-left: 15px;">
                üîÑ Retrain Existing Model
            </button>
            
            <!-- Rank Models Button -->
            <button type="button" class="btn" onclick="showRankModelsDialog()" style="background: #ffc107; color: #333; margin-left: 15px;">
                üèÜ Rank Top Models
            </button>
        </form>
        
        <!-- Rank Models Modal -->
        <div id="rankModelsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
            <div style="max-width: 900px; margin: 80px auto; background: white; border-radius: 12px; padding: 30px; position: relative;">
                <button onclick="closeRankModelsDialog()" style="position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 1.1em;">‚úï</button>
                
                <h2 style="margin-top: 0; color: #333;">üèÜ Rank Top Models in Experiment</h2>
                <p style="color: #666; margin-bottom: 25px;">
                    This will identify and tag the top performing models in an experiment with rankings visible in MLflow UI.
                </p>
                
                <div class="form-group">
                    <label for="rankExperimentName">Experiment Name</label>
                    <select id="rankExperimentName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="">-- Loading experiments... --</option>
                    </select>
                    <div class="help-text">Select an MLflow experiment to rank</div>
                </div>
                
                <div class="two-col">
                    <div class="form-group">
                        <label for="rankMetric">Metric to Rank By</label>
                        <select id="rankMetric" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="balanced_performance" selected>‚≠ê Balanced: High R¬≤ + Low Overfitting</option>
                            <option value="avg_test_r2">Test R¬≤ (higher is better)</option>
                            <option value="avg_test_rmse">Test RMSE (lower is better)</option>
                            <option value="avg_test_mae">Test MAE (lower is better)</option>
                        </select>
                        <div class="help-text">Balanced metric = R¬≤ - (|Test RMSE - Train RMSE| √ó 10)</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="rankTopN">Number of Models to Tag</label>
                        <input type="number" id="rankTopN" value="10" min="1" max="50" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <div class="help-text">Top N models will be tagged (default: 10)</div>
                    </div>
                </div>
                
                <div id="rankResults" style="margin-top: 20px; display: none;">
                    <h3 style="color: #28a745;">‚úÖ Ranking Complete!</h3>
                    <div id="rankResultsContent" style="background: #f8f9fa; padding: 15px; border-radius: 6px; max-height: 400px; overflow-y: auto;"></div>
                </div>
                
                <button onclick="rankModels()" id="rankModelsBtn" style="width: 100%; padding: 15px; background: #ffc107; color: #333; border: none; border-radius: 6px; font-size: 1.1em; cursor: pointer; margin-top: 20px; font-weight: bold;">
                    üèÜ Rank Models Now
                </button>
            </div>
        </div>
        
        <!-- Feature Selection & Retrain Modal -->
        <div id="featureSelectionModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 900px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üéØ Feature Selection & Retrain</h2>
                    <button onclick="closeFeatureSelectionDialog()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">√ó</button>
                </div>
                
                <div id="selectedModelInfo" style="background: #e7f3ff; padding: 15px; border-radius: 6px; margin-bottom: 20px;"></div>
                
                <!-- Training Configuration Form -->
                <div style="margin-bottom: 20px; background: #fff3cd; padding: 15px; border-radius: 6px; border: 1px solid #ffc107;">
                    <h3>‚öôÔ∏è Training Configuration</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Primary Ticker *</label>
                            <input type="text" id="retrainTicker" value="GOOGL" placeholder="e.g., GOOGL" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Context Symbols</label>
                            <input type="text" id="retrainContext" placeholder="e.g., QQQ,VIX" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Start Date *</label>
                            <input type="date" id="retrainStartDate" value="2023-01-01" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">End Date *</label>
                            <input type="date" id="retrainEndDate" value="2024-12-31" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Train Months *</label>
                            <input type="number" id="retrainTrainMonths" value="12" min="1" max="60" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Test Months *</label>
                            <input type="number" id="retrainTestMonths" value="3" min="1" max="12" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Step Months *</label>
                            <input type="number" id="retrainStepMonths" value="3" min="1" max="12" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Number of Trials *</label>
                            <input type="number" id="retrainNumSamples" value="10" min="1" max="100" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                    </div>
                </div>
                
                <div id="featureImportanceSection" style="margin-bottom: 20px;">
                    <h3>üìä Feature Importance</h3>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                        <label style="display: inline-block; margin-right: 20px;">
                            <input type="checkbox" id="autoFilterLowImportance" checked onclick="toggleAutoFilter()">
                            Auto-hide features with importance &lt; 0.0001
                        </label>
                        <button onclick="selectAllFeatures()" style="padding: 5px 10px; margin-right: 10px;">Select All</button>
                        <button onclick="deselectAllFeatures()" style="padding: 5px 10px;">Deselect All</button>
                    </div>
                    <div id="featureList" style="max-height: 400px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px;"></div>
                </div>
                
                <button onclick="trainWithSelectedFeatures()" id="retrainBtn" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                    üöÄ Train New Model with Selected Features
                </button>
            </div>
        </div>
        
        <!-- Retrain Workflow Modal -->
        <div id="retrainModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
            <div style="max-width: 1200px; margin: 40px auto; background: white; border-radius: 12px; padding: 30px; position: relative;">
                <button onclick="closeRetrainWorkflow()" style="position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 1.1em;">‚úï</button>
                
                <h2 style="margin-bottom: 25px; color: #333;">üîÑ Retrain Existing Model</h2>
                
                <!-- Step 1: Model Selection -->
                <div id="retrainStep1" class="retrain-step">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Step 1: Select Model to Retrain</h3>
                    
                    <div class="help-text" style="margin-bottom: 20px;">
                        Choose a previously trained model. Configuration and feature sets will be loaded automatically.
                    </div>
                    
                    <div id="modelListLoading" style="text-align: center; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
                        Loading trained models...
                    </div>
                    
                    <div id="modelListContainer" style="display: none;">
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #667eea;">
                                    <th style="padding: 12px; text-align: left;">Select</th>
                                    <th style="padding: 12px; text-align: left;">Algorithm</th>
                                    <th style="padding: 12px; text-align: left;">Ticker</th>
                                    <th style="padding: 12px; text-align: center;">Features</th>
                                    <th style="padding: 12px; text-align: center;">Folds</th>
                                    <th style="padding: 12px; text-align: center;">Test R¬≤</th>
                                    <th style="padding: 12px; text-align: center;">Test RMSE</th>
                                    <th style="padding: 12px; text-align: left;">Context</th>
                                    <th style="padding: 12px; text-align: left;">Date</th>
                                </tr>
                            </thead>
                            <tbody id="modelListTable">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                        
                        <button type="button" class="btn btn-primary" onclick="loadModelDetails()">
                            Next: Configure Features ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Feature Selection -->
                <div id="retrainStep2" class="retrain-step" style="display: none;">
                    <button type="button" onclick="showRetrainStep(1)" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-bottom: 20px;">
                        ‚Üê Back to Model Selection
                    </button>
                    
                    <h3 style="color: #667eea; margin-bottom: 20px;">Step 2: Review Configuration & Select Features</h3>
                    
                    <!-- Model Info Summary -->
                    <div id="selectedModelInfo" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #667eea;">
                        <!-- Populated dynamically -->
                    </div>
                    
                    <!-- Configuration Parameters -->
                    <div style="background: white; border: 2px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                        <h4 style="margin-bottom: 15px; color: #333;">üìã Training Configuration</h4>
                        <div id="retrainConfigDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Feature Selection Grid -->
                    <div style="background: white; border: 2px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #333;">üéØ Feature Selection</h4>
                            <div>
                                <button type="button" onclick="selectAllFeatures()" class="btn" style="background: #28a745; margin-right: 10px;">‚úì Select All</button>
                                <button type="button" onclick="deselectAllFeatures()" class="btn" style="background: #6c757d;">‚úó Clear All</button>
                                <button type="button" onclick="selectHighImportanceOnly()" class="btn" style="background: #667eea; margin-left: 10px;">‚≠ê High Importance Only</button>
                            </div>
                        </div>
                        
                        <div class="help-text" style="margin-bottom: 15px;">
                            <strong>‚úì Checked</strong> features will be included in retraining. 
                            <strong style="color: #dc3545;">Low importance</strong> features are unchecked by default (below median importance).
                            Median importance: <span id="medianImportanceValue">-</span>
                        </div>
                        
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 15px; border-radius: 6px;">
                            <strong>‚ö†Ô∏è XGBoost Retraining Note:</strong>
                            <div style="margin-top: 8px; font-size: 0.95em;">
                                When excluding features, a <strong>new model</strong> is trained from scratch (not incremental).
                                XGBoost's <code>xgb_model</code> parameter requires the same feature set.
                                For true incremental learning (adding trees), keep all features and use longer training runs.
                            </div>
                        </div>
                        
                        <div id="featureSelectionLoading" style="text-align: center; padding: 40px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
                            Loading feature importance data...
                        </div>
                        
                        <div id="featureSelectionGrid" style="display: none; max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">Include</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">Feature Name</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #667eea;">Importance</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #667eea;">Rank</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #667eea;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="featureTableBody">
                                    <!-- Populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="featureSelectionSummary" style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 6px; display: none;">
                            <strong>Selection Summary:</strong>
                            <span id="selectedFeatureCount">0</span> of <span id="totalFeatureCount">0</span> features selected
                            (<span id="excludedFeatureCount">0</span> excluded)
                        </div>
                    </div>
                    
                    <!-- Submit Retrain -->
                    <button type="button" class="btn btn-primary" onclick="submitRetrain()" id="retrainSubmitBtn">
                        üöÄ Start Retraining with Selected Features
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Fold Inspector Section -->
        <div class="section" style="margin-top: 30px;">
            <div class="section-header">
                <h2>üìä Fold Inspector</h2>
                <div class="help-text" style="margin-top: 10px;">
                    View pre-computed folds and their feature columns. Helps verify data is ready before training.
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <div class="form-group">
                    <label for="inspectSymbol">Symbol</label>
                    <input type="text" id="inspectSymbol" placeholder="e.g., GOOGL" value="GOOGL">
                </div>
                
                <button type="button" class="btn btn-primary" onclick="loadFoldsList()" style="margin-bottom: 20px;">
                    üîç Load Available Folds
                </button>
                
                <div id="foldsListContainer" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: #333;">Available Folds</h3>
                    <div id="foldsList"></div>
                </div>
                
                <div id="foldDetailsContainer" style="display: none; margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: #333;">Fold Details</h3>
                    <div id="foldDetails"></div>
                </div>
            </div>
        </div>
        
        <!-- Backtesting Section -->
        <div class="section" style="margin-top: 30px;">
            <h2>üéØ Model Backtesting (VectorBT)</h2>
            <p class="help-text" style="margin-bottom: 20px;">
                Validate trained models with realistic trading simulation including fees and slippage
            </p>
            
            <div class="form-group">
                <label for="backtestExperiment">Select Trained Model</label>
                <select id="backtestExperiment" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em;">
                    <option value="">-- Loading available models... --</option>
                </select>
                <div class="help-text" id="modelInfoHelp">Select an experiment to view model details</div>
            </div>
            
            <div class="form-group">
                <label>Symbols to Backtest</label>
                <div id="backtestSymbolGrid" class="symbol-grid">
                    <!-- Populated dynamically -->
                </div>
                <div class="help-text">Select which symbols to test the model against (leave empty for all available)</div>
            </div>
            
            <div class="section" style="background: white; border-left: 4px solid #764ba2; margin: 20px 0;">
                <h3 style="font-size: 1.1em; margin-bottom: 15px;">Walk-Forward Configuration</h3>
                <div class="two-col">
                    <div class="form-group">
                        <label for="backtestTrainMonths">Training Window (months)</label>
                        <input type="number" id="backtestTrainMonths" value="3" min="1" max="12">
                        <div class="help-text">Months of training data per fold</div>
                    </div>
                    <div class="form-group">
                        <label for="backtestTestMonths">Test Window (months)</label>
                        <input type="number" id="backtestTestMonths" value="1" min="1" max="6">
                        <div class="help-text">Months of test data per fold</div>
                    </div>
                </div>
                <div class="two-col">
                    <div class="form-group">
                        <label for="backtestStepMonths">Step Size (months)</label>
                        <input type="number" id="backtestStepMonths" value="1" min="1" max="6">
                        <div class="help-text">Step forward increment</div>
                    </div>
                    <div class="form-group">
                        <label for="backtestStartDate">Start Date (optional)</label>
                        <input type="date" id="backtestStartDate">
                        <div class="help-text" id="backtestStartDateHelp">Auto-populated from symbol data</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="backtestEndDate">End Date (optional)</label>
                    <input type="date" id="backtestEndDate">
                    <div class="help-text" id="backtestEndDateHelp">Auto-populated from symbol data</div>
                </div>
            </div>
            
            <div class="two-col">
                <div class="form-group">
                    <label for="initialCapital">Initial Capital ($)</label>
                    <input type="number" id="initialCapital" value="100000" min="1000" step="1000">
                    <div class="help-text">Starting portfolio value</div>
                </div>
                <div class="form-group">
                    <label for="commission">Commission (%)</label>
                    <input type="number" id="commission" value="0.1" min="0" max="5" step="0.01">
                    <div class="help-text">Trading fees per transaction</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="slippage">Slippage (%)</label>
                <input type="number" id="slippage" value="0.05" min="0" max="5" step="0.01">
                <div class="help-text">Price impact of market orders</div>
            </div>
            
            <details style="margin-bottom: 10px;">
                <summary style="cursor: pointer; padding: 10px; background: #f0f0f0; border-radius: 6px; font-weight: 500;">
                    ‚öôÔ∏è Advanced: Manual Fold Generation
                </summary>
                <div style="padding: 10px; margin-top: 10px; background: #f9f9f9; border-radius: 6px;">
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        Folds are auto-generated when you run backtest. Use this only if you need to pre-generate or regenerate folds manually.
                    </p>
                    <button type="button" class="btn btn-secondary" id="generateFoldsBtn" onclick="generateFoldsOnly()" style="width: 100%; background: #FFA500;">
                        üìÅ Generate Fold Data Only
                    </button>
                </div>
            </details>
            
            <button type="button" class="btn btn-primary" id="backtestBtn" onclick="runBacktest()">
                üìä Run Backtest
            </button>
            
            <div id="backtestStatus" class="status"></div>
            
            <div id="backtestResults" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-bottom: 15px;">Backtest Results</h3>
                <div id="backtestResultsContent"></div>
            </div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="links">
            <h3 style="margin-bottom: 10px;">üìä Monitoring Links</h3>
            <a id="rayDashboardLink" href="#" target="_blank">Ray Dashboard</a>
            <a id="grafanaLink" href="#" target="_blank">Grafana</a>
            <a id="prometheusLink" href="#" target="_blank">Prometheus</a>
            <a href="/status" target="_blank">API Status</a>
        </div>
    </div>
    
    <script>
        let availableSymbols = [];
        let symbolDateRanges = {}; // Store per-symbol date ranges
        let dateRange = { start: null, end: null };
        
        // Detect environment and set monitoring links
        function setupMonitoringLinks() {
            const hostname = window.location.hostname;
            const isCodespaces = hostname.includes('.app.github.dev');
            
            if (isCodespaces) {
                // GitHub Codespaces pattern: cuddly-trout-v959vxxj7gc6p79-{PORT}.app.github.dev
                const baseUrl = hostname.replace(/-\d+\./, '-');  // Remove port
                document.getElementById('rayDashboardLink').href = `https://${baseUrl}8265.app.github.dev/`;
                document.getElementById('grafanaLink').href = `https://${baseUrl}3000.app.github.dev/`;
                document.getElementById('prometheusLink').href = `https://${baseUrl}9090.app.github.dev/`;
            } else {
                // Local development
                document.getElementById('rayDashboardLink').href = 'http://localhost:8265';
                document.getElementById('grafanaLink').href = 'http://localhost:3000';
                document.getElementById('prometheusLink').href = 'http://localhost:9090';
            }
        }
        
        // Initialize monitoring links on page load
        setupMonitoringLinks();
        
        // Load available symbols and date ranges
        async function loadData() {
            document.getElementById('loadingData').style.display = 'block';
            
            try {
                // Get streaming status to discover symbols
                const response = await fetch('/streaming/status');
                const data = await response.json();
                
                console.log('loadData - Streaming status:', data);
                
                if (data.data_sources && data.data_sources.symbols) {
                    // Extract symbols with date ranges
                    const symbols = data.data_sources.symbols;
                    const maxAllowedDate = data.data_sources.max_allowed_date; // Backend enforces Month-1
                    
                    availableSymbols = symbols.map(s => s.symbol).sort();
                    console.log('loadData - Available symbols:', availableSymbols);
                    
                    // Store per-symbol date ranges
                    symbols.forEach(s => {
                        // Strip 'dt=' prefix if present
                        const startDate = s.date_range.start.replace(/^dt=/, '');
                        const endDate = s.date_range.end.replace(/^dt=/, '');
                        
                        symbolDateRanges[s.symbol] = {
                            start: startDate,
                            end: endDate,
                            capped: s.date_range.capped || false  // Was end date capped?
                        };
                    });
                    
                    // Find overall date range across all symbols
                    if (symbols.length > 0) {
                        const allStarts = symbols.map(s => s.date_range.start.replace(/^dt=/, ''));
                        const allEnds = symbols.map(s => s.date_range.end.replace(/^dt=/, ''));
                        
                        dateRange.start = allStarts.reduce((min, d) => !min || d < min ? d : min, null);
                        dateRange.end = allEnds.reduce((max, d) => !max || d > max ? d : max, null);
                    }
                }
                
                // Fallback to reasonable defaults if no data
                if (!dateRange.start || !dateRange.end) {
                    const today = new Date();
                    const sixMonthsAgo = new Date(today);
                    sixMonthsAgo.setMonth(today.getMonth() - 6);
                    
                    dateRange.start = sixMonthsAgo.toISOString().split('T')[0];
                    dateRange.end = today.toISOString().split('T')[0];
                }
                
                populateSymbols();
                
                // Auto-select first symbol and set its date range as default
                if (availableSymbols.length > 0) {
                    const firstSymbol = availableSymbols[0];
                    const firstCheckbox = document.getElementById(`sym_${firstSymbol}`);
                    if (firstCheckbox) {
                        firstCheckbox.checked = true;
                        // Manually trigger the date update
                        if (symbolDateRanges[firstSymbol]) {
                            const range = symbolDateRanges[firstSymbol];
                            console.log('Setting dates for', firstSymbol, range);
                            
                            const startInput = document.getElementById('startDate');
                            const endInput = document.getElementById('endDate');
                            
                            if (startInput && endInput) {
                                startInput.value = range.start;
                                endInput.value = range.end;
                                
                                startInput.min = dateRange.start;
                                startInput.max = dateRange.end;
                                endInput.min = dateRange.start;
                                endInput.max = dateRange.end;
                                
                                console.log('Date inputs set:', startInput.value, endInput.value);
                                
                                // Show capped warning if applicable
                                const cappedWarning = range.capped ? ' ‚ö†Ô∏è (capped to previous month)' : '';
                                
                                document.getElementById('startDateHelp').textContent = 
                                    `${firstSymbol}: ${range.start} (Overall: ${dateRange.start})`;
                                document.getElementById('endDateHelp').textContent = 
                                    `${firstSymbol}: ${range.end}${cappedWarning} (Overall: ${dateRange.end})`;
                            } else {
                                console.error('Date inputs not found!');
                            }
                        }
                    }
                } else {
                    populateDates();
                }
                
                // Update API examples after data is loaded
                setTimeout(updateApiExamples, 100);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showStatus('error', 'Failed to load symbols. Please check if data is available.');
            } finally {
                document.getElementById('loadingData').style.display = 'none';
            }
        }
        
        function populateSymbols() {
            const symbolGrid = document.getElementById('symbolGrid');
            const contextGrid = document.getElementById('contextSymbolGrid');
            const backtestGrid = document.getElementById('backtestSymbolGrid');
            
            console.log('populateSymbols - symbolGrid:', symbolGrid, 'contextGrid:', contextGrid, 'backtestGrid:', backtestGrid);
            console.log('populateSymbols - availableSymbols:', availableSymbols);
            
            // Use available symbols from parquet data
            const allSymbols = availableSymbols.length > 0 ? availableSymbols : ['AAPL', 'MSFT', 'GOOGL'];
            
            console.log('populateSymbols - allSymbols:', allSymbols);
            
            // Populate primary symbols - use all available symbols
            allSymbols.forEach(symbol => {
                const div = document.createElement('div');
                div.className = 'symbol-item';
                div.innerHTML = `
                    <input type="checkbox" id="sym_${symbol}" value="${symbol}">
                    <label for="sym_${symbol}">${symbol}</label>
                `;
                symbolGrid.appendChild(div);
                
                // Add event listener to update dates when symbol is selected
                const checkbox = div.querySelector('input');
                checkbox.addEventListener('change', () => {
                    updateDatesFromSelectedSymbol();
                    updateApiExamples();
                });
            });
            
            // Populate context symbols - use same list (all available symbols)
            allSymbols.forEach(symbol => {
                const div = document.createElement('div');
                div.className = 'symbol-item';
                div.innerHTML = `
                    <input type="checkbox" id="ctx_${symbol}" value="${symbol}">
                    <label for="ctx_${symbol}">${symbol}</label>
                `;
                contextGrid.appendChild(div);
                
                // Update API examples when context symbols change too
                const checkbox = div.querySelector('input');
                checkbox.addEventListener('change', updateApiExamples);
            });
            
            // Populate backtest symbols
            allSymbols.forEach(symbol => {
                const div = document.createElement('div');
                div.className = 'symbol-item';
                div.innerHTML = `
                    <input type="checkbox" id="btest_${symbol}" value="${symbol}">
                    <label for="btest_${symbol}">${symbol}</label>
                `;
                backtestGrid.appendChild(div);
                
                // Update API examples and dates when backtest symbols change
                const checkbox = div.querySelector('input');
                checkbox.addEventListener('change', () => {
                    populateBacktestDates();
                    updateApiExamples();
                });
            });
        }
        
        function updateDatesFromSelectedSymbol() {
            // Get the first selected primary symbol
            const selectedSymbols = Array.from(document.querySelectorAll('#symbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedSymbols.length === 0) {
                // No symbols selected, use overall range
                populateDates();
                return;
            }
            
            // Use the date range of the first selected symbol as the primary target
            const primarySymbol = selectedSymbols[0];
            if (symbolDateRanges[primarySymbol]) {
                const range = symbolDateRanges[primarySymbol];
                const startInput = document.getElementById('startDate');
                const endInput = document.getElementById('endDate');
                
                startInput.value = range.start;
                endInput.value = range.end;
                
                // Still allow full range adjustment
                startInput.min = dateRange.start;
                startInput.max = dateRange.end;
                endInput.min = dateRange.start;
                endInput.max = dateRange.end;
                
                document.getElementById('startDateHelp').textContent = 
                    `${primarySymbol}: ${range.start} (Overall: ${dateRange.start})`;
                document.getElementById('endDateHelp').textContent = 
                    `${primarySymbol}: ${range.end} (Overall: ${dateRange.end})`;
            } else {
                populateDates();
            }
        }
        
        function populateDates() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            startInput.value = dateRange.start;
            endInput.value = dateRange.end;
            
            startInput.min = dateRange.start;
            startInput.max = dateRange.end;
            endInput.min = dateRange.start;
            endInput.max = dateRange.end;
            
            document.getElementById('startDateHelp').textContent = `Earliest: ${dateRange.start}`;
            document.getElementById('endDateHelp').textContent = `Latest: ${dateRange.end}`;
        }
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        // Form submission
        document.getElementById('trainingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Starting Training...';
            
            // Collect selected symbols
            const symbols = Array.from(document.querySelectorAll('#symbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            const contextSymbols = Array.from(document.querySelectorAll('#contextSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (symbols.length === 0) {
                showStatus('error', 'Please select at least one primary symbol');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Start Walk-Forward Training';
                return;
            }
            
            // Parse windows
            const windows = document.getElementById('windows').value
                .split(',')
                .map(w => parseInt(w.trim()))
                .filter(w => !isNaN(w));
            
            // Parse resampling timeframes
            const resamplingInput = document.getElementById('resamplingTimeframes').value.trim();
            const resamplingTimeframes = resamplingInput
                ? resamplingInput.split(',').map(t => t.trim())
                : null;
            
            // Build request payload
            const payload = {
                symbols: symbols,
                context_symbols: contextSymbols.length > 0 ? contextSymbols : null,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                train_months: parseInt(document.getElementById('trainMonths').value),
                test_months: parseInt(document.getElementById('testMonths').value),
                step_months: parseInt(document.getElementById('stepMonths').value),
                algorithm: document.querySelector('input[name="algorithm"]:checked').value,
                num_samples: parseInt(document.getElementById('numSamples').value),
                num_gpus: parseFloat(document.getElementById('numGpus').value),
                skip_empty_folds: document.getElementById('skipEmptyFolds').checked,
                windows: windows,
                resampling_timeframes: resamplingTimeframes
            };
            
            try {
                const response = await fetch('/train/walk_forward', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const rayDashboardUrl = document.getElementById('rayDashboardLink').href;
                    showStatus('success', 
                        `Training started! ${result.num_samples} trials across ${symbols.join(', ')}. ` +
                        `Check Ray Dashboard for progress: ${rayDashboardUrl}`
                    );
                } else {
                    showStatus('error', `Failed to start training: ${result.detail || 'Unknown error'}`);
                }
            } catch (error) {
                showStatus('error', `Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Start Walk-Forward Training';
            }
        });
        
        // Load data on page load
        loadData();
        loadAvailableModels();
        
        // ============================================================================
        // Model Selection Functions
        // ============================================================================
        
        let availableModels = [];
        
        async function loadAvailableModels() {
            try {
                const response = await fetch('/backtest/experiments');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                console.log('Loaded models:', data);
                availableModels = data.experiments || [];
                populateModelDropdown();
                
            } catch (error) {
                console.error('Error loading models:', error);
                const select = document.getElementById('backtestExperiment');
                if (select) {
                    select.innerHTML = '<option value="">-- Error loading models --</option>';
                }
            }
        }
        
        function populateModelDropdown() {
            const select = document.getElementById('backtestExperiment');
            if (!select) return;
            
            if (availableModels.length === 0) {
                select.innerHTML = '<option value="">-- No trained models available --</option>';
                return;
            }
            
            // Sort models by test RMSE (best first)
            availableModels.sort((a, b) => {
                const rmseA = a.model_info?.test_rmse || Infinity;
                const rmseB = b.model_info?.test_rmse || Infinity;
                return rmseA - rmseB;
            });
            
            // Build options with detailed info
            let html = '<option value="">-- Select a model --</option>';
            availableModels.forEach(model => {
                const info = model.model_info;
                let optionText = `${info?.algorithm?.toUpperCase() || 'Unknown'} - ${info?.ticker || 'Unknown'}`;
                
                if (info) {
                    const rmse = info.test_rmse ? info.test_rmse.toFixed(6) : 'N/A';
                    const r2 = info.test_r2 ? info.test_r2.toFixed(4) : 'N/A';
                    optionText += ` | RMSE: ${rmse} | R¬≤: ${r2}`;
                }
                
                html += `<option value="${model.name}">${optionText}</option>`;
            });
            
            select.innerHTML = html;
            
            // Add change listener to show model details
            select.removeEventListener('change', showModelDetails);
            select.addEventListener('change', showModelDetails);
        }
        
        function showModelDetails() {
            const select = document.getElementById('backtestExperiment');
            const helpText = document.getElementById('modelInfoHelp');
            
            if (!select || !helpText) return;
            
            const selectedName = select.value;
            if (!selectedName) {
                helpText.innerHTML = 'Select a model to view details';
                populateBacktestDates(null);
                return;
            }
            
            const model = availableModels.find(m => m.name === selectedName);
            if (!model || !model.model_info) {
                helpText.innerHTML = 'Model details unavailable';
                populateBacktestDates(null);
                return;
            }
            
            const info = model.model_info;
            const dateRange = info.date_range || {};
            
            helpText.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>üìä Performance Metrics</strong>
                            <div style="margin-top: 8px; font-size: 0.95em;">
                                ‚Ä¢ Test RMSE: <strong>${info.test_rmse ? info.test_rmse.toFixed(6) : 'N/A'}</strong><br>
                                ‚Ä¢ Test R¬≤: <strong>${info.test_r2 ? info.test_r2.toFixed(4) : 'N/A'}</strong><br>
                                ‚Ä¢ Test MAE: <strong>${info.test_mae ? info.test_mae.toFixed(6) : 'N/A'}</strong><br>
                                ‚Ä¢ Train RMSE: <strong>${info.train_rmse ? info.train_rmse.toFixed(6) : 'N/A'}</strong><br>
                                ‚Ä¢ Folds: <strong>${info.num_folds || 'N/A'}</strong>
                            </div>
                        </div>
                        <div>
                            <strong>üîß Model Configuration</strong>
                            <div style="margin-top: 8px; font-size: 0.95em;">
                                ‚Ä¢ Algorithm: <strong>${info.algorithm?.toUpperCase() || 'N/A'}</strong><br>
                                ‚Ä¢ Trained on: <strong>${info.ticker || 'N/A'}</strong><br>
                                ‚Ä¢ Date Range: <strong>${dateRange.start || 'N/A'} to ${dateRange.end || 'N/A'}</strong><br>
                                ‚Ä¢ Features: <strong>${info.feature_version || 'N/A'}</strong>
                            </div>
                        </div>
                    </div>
                    ${info.params ? `
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: 600;">View Hyperparameters</summary>
                            <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 5px; overflow-x: auto; font-size: 0.85em;">${JSON.stringify(info.params, null, 2)}</pre>
                        </details>
                    ` : ''}
                </div>
            `;
            
            // Trigger API example update
            updateApiExamples();
        }
        
        function populateBacktestDates() {
            const startInput = document.getElementById('backtestStartDate');
            const endInput = document.getElementById('backtestEndDate');
            const startHelp = document.getElementById('backtestStartDateHelp');
            const endHelp = document.getElementById('backtestEndDateHelp');
            
            if (!startInput || !endInput) return;
            
            // Get selected symbols from backtest grid
            const selectedSymbols = Array.from(document.querySelectorAll('#backtestSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedSymbols.length === 0) {
                // Clear if no symbols selected
                startInput.value = '';
                endInput.value = '';
                startInput.removeAttribute('min');
                startInput.removeAttribute('max');
                endInput.removeAttribute('min');
                endInput.removeAttribute('max');
                
                if (startHelp) startHelp.textContent = 'Select symbols to auto-populate';
                if (endHelp) endHelp.textContent = 'Select symbols to auto-populate';
                return;
            }
            
            // Compute overall date range across selected symbols
            let overallStart = null;
            let overallEnd = null;
            
            selectedSymbols.forEach(symbol => {
                if (symbolDateRanges[symbol]) {
                    const range = symbolDateRanges[symbol];
                    
                    if (!overallStart || range.start < overallStart) {
                        overallStart = range.start;
                    }
                    if (!overallEnd || range.end > overallEnd) {
                        overallEnd = range.end;
                    }
                }
            });
            
            if (!overallStart || !overallEnd) {
                if (startHelp) startHelp.textContent = 'No data available for selected symbols';
                if (endHelp) endHelp.textContent = 'No data available for selected symbols';
                return;
            }
            
            // Set values to overall date range
            startInput.value = overallStart;
            endInput.value = overallEnd;
            
            // Set min/max constraints
            startInput.min = overallStart;
            startInput.max = overallEnd;
            endInput.min = overallStart;
            endInput.max = overallEnd;
            
            // Update help text with symbol count
            const symbolList = selectedSymbols.length <= 3 ? selectedSymbols.join(', ') : `${selectedSymbols.length} symbols`;
            if (startHelp) startHelp.textContent = `${symbolList}: Earliest ${overallStart}`;
            if (endHelp) endHelp.textContent = `${symbolList}: Latest ${overallEnd}`;
            
            console.log(`Auto-populated backtest dates for ${selectedSymbols.join(', ')}: ${overallStart} to ${overallEnd}`);
        }
        
        // ============================================================================
        // Backtesting Functions
        // ============================================================================
        
        async function generateFoldsOnly() {
            const btn = document.getElementById('generateFoldsBtn');
            
            // Get selected symbols from backtest grid
            const selectedSymbols = Array.from(document.querySelectorAll('#backtestSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedSymbols.length === 0) {
                showBacktestStatus('error', 'Please select at least one symbol in "Symbols to Backtest"');
                return;
            }
            
            if (selectedSymbols.length > 1) {
                showBacktestStatus('error', 'Please select only ONE symbol at a time for fold generation');
                return;
            }
            
            const symbol = selectedSymbols[0];
            
            // Get dates
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            
            if (!startDate || !endDate) {
                showBacktestStatus('error', 'Please select start and end dates (auto-populated from symbol data)');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating Folds...';
            showBacktestStatus('info', `Generating fold data for ${symbol}...`);
            
            const payload = {
                symbol: symbol,
                start_date: startDate,
                end_date: endDate,
                train_months: parseInt(document.getElementById('backtestTrainMonths').value),
                test_months: parseInt(document.getElementById('backtestTestMonths').value),
                step_months: parseInt(document.getElementById('backtestStepMonths').value)
            };
            
            try {
                const response = await fetch('/streaming/generate-folds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showBacktestStatus('success', 
                        `‚úÖ Fold generation started for ${symbol}! ` +
                        `Train: ${result.fold_config.train_months}mo, Test: ${result.fold_config.test_months}mo, Step: ${result.fold_config.step_months}mo. ` +
                        `Check logs for progress. Output: ${result.output_path}/fold_*/`
                    );
                } else {
                    showBacktestStatus('error', `Fold generation failed: ${result.detail || 'Unknown error'}`);
                }
                
            } catch (error) {
                showBacktestStatus('error', `Network error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìÅ Generate Fold Data Only';
            }
        }
        
        async function runBacktest() {
            const backtestBtn = document.getElementById('backtestBtn');
            const select = document.getElementById('backtestExperiment');
            const experimentName = select ? select.value : '';
            
            if (!experimentName) {
                showBacktestStatus('error', 'Please select a trained model');
                return;
            }
            
            // Get selected symbols
            const symbols = Array.from(document.querySelectorAll('#backtestSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            backtestBtn.disabled = true;
            backtestBtn.textContent = '‚è≥ Running Backtest...';
            showBacktestStatus('info', 'Starting backtest simulation... This may take 2-5 minutes if generating folds.');
            
            const payload = {
                experiment_name: experimentName,
                symbols: symbols.length > 0 ? symbols : null,  // null means use all available
                train_months: parseInt(document.getElementById('backtestTrainMonths').value),
                test_months: parseInt(document.getElementById('backtestTestMonths').value),
                step_months: parseInt(document.getElementById('backtestStepMonths').value),
                start_date: document.getElementById('backtestStartDate').value || null,
                end_date: document.getElementById('backtestEndDate').value || null,
                initial_capital: parseFloat(document.getElementById('initialCapital').value),
                commission: parseFloat(document.getElementById('commission').value) / 100,  // Convert % to decimal
                slippage: parseFloat(document.getElementById('slippage').value) / 100  // Convert % to decimal
            };
            
            try {
                // Extended timeout for fold generation (5 minutes)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 min timeout
                
                const response = await fetch('/backtest/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned non-JSON response: ${text.substring(0, 200)}`);
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    // Check for folds_required status
                    if (result.status === 'folds_required' || result.status === 'generating_folds') {
                        showBacktestStatus('info', result.message);
                        displayFoldGenerationInstructions(result);
                    } else {
                        showBacktestStatus('success', 'Backtest completed successfully!');
                        displayBacktestResults(result);
                    }
                } else {
                    showBacktestStatus('error', `Backtest failed: ${result.detail || 'Unknown error'}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showBacktestStatus('error', 'Request timed out. The backtest is taking longer than expected (>5 minutes). Check server logs.');
                } else {
                    showBacktestStatus('error', `Error: ${error.message}`);
                }
            } finally {
                backtestBtn.disabled = false;
                backtestBtn.textContent = 'üìä Run Backtest';
            }
        }
        
        function showBacktestStatus(type, message) {
            const statusDiv = document.getElementById('backtestStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        function displayFoldGenerationInstructions(result) {
            const resultsDiv = document.getElementById('backtestResults');
            const contentDiv = document.getElementById('backtestResultsContent');
            
            const instructions = result.instructions || {};
            const symbol = result.symbol;
            
            contentDiv.innerHTML = `
                <div style="padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="margin-top: 0;">üìÅ Fold Generation Required</h4>
                    <p><strong>Symbol:</strong> ${symbol}</p>
                    <p>Walk-forward folds with full feature engineering must be generated before backtesting.</p>
                    
                    ${result.background_task ? `
                        <div id="foldGenerationProgress" style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div class="spinner" style="width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <strong>Background Task Running...</strong>
                            </div>
                            <div id="foldStatus" style="font-family: monospace; font-size: 0.9em; color: #666;">
                                Checking status...
                            </div>
                            <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                                <em>This page will auto-refresh status every 3 seconds</em>
                            </div>
                        </div>
                    ` : ''}
                    
                    <h5 style="margin-top: 20px; margin-bottom: 10px;">Option 1: Use This Dashboard</h5>
                    <ol style="line-height: 1.8;">
                        <li>Scroll up to the training form</li>
                        <li>Set <strong>Primary Symbol</strong> to: <code>${symbol}</code></li>
                        <li>Click <strong>"Generate Fold Data Only"</strong> button (under Advanced section)</li>
                        <li>Wait 2-5 minutes for fold generation with Ray Data preprocessing</li>
                        <li>Return here and click <strong>"Run Backtest"</strong> again</li>
                    </ol>
                    
                    ${instructions.alternative ? `
                        <h5 style="margin-top: 15px; margin-bottom: 10px;">Option 2: Use API</h5>
                        <pre style="background: #f8f9fa; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 0.9em;">${instructions.alternative}</pre>
                    ` : ''}
                    
                    <p style="margin-top: 15px; color: #666; font-size: 0.95em;">
                        <strong>Why?</strong> Folds must use the same Ray Data preprocessing pipeline and feature engineering 
                        as the original training to ensure feature compatibility with the trained model.
                    </p>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            
            // Start polling if background task is running
            if (result.background_task && symbol) {
                pollFoldGenerationStatus(symbol);
            }
        }
        
        let foldStatusInterval = null;
        
        function pollFoldGenerationStatus(symbol) {
            // Clear any existing interval
            if (foldStatusInterval) {
                clearInterval(foldStatusInterval);
            }
            
            async function checkStatus() {
                try {
                    const response = await fetch(`/backtest/fold-status/${symbol}`);
                    const status = await response.json();
                    
                    const statusDiv = document.getElementById('foldStatus');
                    if (!statusDiv) {
                        clearInterval(foldStatusInterval);
                        return;
                    }
                    
                    if (status.status === 'generating') {
                        statusDiv.innerHTML = `
                            <div style="color: #0066cc;">
                                <strong>Status:</strong> Generating folds...<br>
                                <strong>Progress:</strong> Fold ${status.current_fold} ${status.total_folds !== 'calculating...' ? '/ ' + status.total_folds : ''}<br>
                                <strong>Message:</strong> ${status.message}
                            </div>
                        `;
                    } else if (status.status === 'completed') {
                        statusDiv.innerHTML = `
                            <div style="color: #28a745;">
                                <strong>‚úÖ Completed!</strong><br>
                                Generated ${status.total_folds} folds successfully.<br>
                                <em>You can now run the backtest.</em>
                            </div>
                        `;
                        clearInterval(foldStatusInterval);
                        
                        // Update progress box
                        document.getElementById('foldGenerationProgress').style.background = '#d4edda';
                        document.getElementById('foldGenerationProgress').style.borderLeft = '4px solid #28a745';
                    } else if (status.status === 'failed') {
                        statusDiv.innerHTML = `
                            <div style="color: #dc3545;">
                                <strong>‚ùå Failed</strong><br>
                                ${status.message}
                            </div>
                        `;
                        clearInterval(foldStatusInterval);
                        
                        // Update progress box
                        document.getElementById('foldGenerationProgress').style.background = '#f8d7da';
                        document.getElementById('foldGenerationProgress').style.borderLeft = '4px solid #dc3545';
                    }
                } catch (error) {
                    console.error('Error checking fold status:', error);
                }
            }
            
            // Check immediately
            checkStatus();
            
            // Then poll every 3 seconds
            foldStatusInterval = setInterval(checkStatus, 3000);
        }
        
        function displayBacktestResults(result) {
            const resultsDiv = document.getElementById('backtestResults');
            const contentDiv = document.getElementById('backtestResultsContent');
            
            // Check if result has the expected structure
            if (!result || !result.results) {
                contentDiv.innerHTML = `
                    <div style="padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="margin-top: 0;">‚ö†Ô∏è Invalid Backtest Result</h4>
                        <p>The backtest returned an unexpected result format.</p>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }
            
            const summary = result.results;
            
            // Create assessment badge (with defaults for missing properties)
            const assessmentColors = {
                'EXCELLENT': 'üü¢',
                'GOOD': 'üü°',
                'MARGINAL': 'üü†',
                'POOR': 'üî¥'
            };
            const assessment = summary.assessment || 'N/A';
            const badge = assessmentColors[assessment] || '‚ö™';
            
            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: white; border-radius: 6px; border-left: 4px solid #667eea;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Assessment</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${badge} ${assessment}</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Return</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: ${(summary.avg_total_return || 0) >= 0 ? '#28a745' : '#dc3545'};">
                            ${((summary.avg_total_return || 0) * 100).toFixed(2)}%
                        </div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Sharpe Ratio</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${(summary.avg_sharpe_ratio || 0).toFixed(3)}</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Max Drawdown</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">
                            ${(summary.avg_max_drawdown * 100).toFixed(2)}%
                        </div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Win Rate</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${(summary.avg_win_rate * 100).toFixed(1)}%</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Trades</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${summary.avg_num_trades.toFixed(0)}</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Return Consistency</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${summary.return_consistency.toFixed(3)}</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 6px;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">vs Buy & Hold</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: ${summary.avg_alpha >= 0 ? '#28a745' : '#dc3545'};">
                            ${summary.avg_alpha >= 0 ? '+' : ''}${(summary.avg_alpha * 100).toFixed(2)}%
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">
                    <strong>Model Info:</strong><br>
                    Trial: ${result.model_info.trial_id}<br>
                    RMSE: ${result.model_info.test_rmse.toFixed(6)}<br>
                    R¬≤: ${result.model_info.test_r2.toFixed(4)}
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }
        
        // ============================================================================
        // API Sidebar Functions
        // ============================================================================
        
        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        }
        
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.querySelector('.api-toggle-btn');
            const header = sidebar.querySelector('h2');
            const content = sidebar.querySelector('.sidebar-content');
            
            sidebar.classList.toggle('visible');
            
            if (sidebar.classList.contains('visible')) {
                content.style.display = 'block';
                header.innerHTML = 'üîå API Reference';
                toggleBtn.style.opacity = '0.7';
            } else {
                content.style.display = 'none';
                header.innerHTML = 'üîå API Reference (Click to expand)';
                toggleBtn.style.opacity = '1';
            }
        }
        
        function copyCurl(btn) {
            const codeSpan = btn.nextElementSibling;
            const text = codeSpan.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.classList.add('copied');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                btn.textContent = '‚úó Failed';
                setTimeout(() => {
                    btn.textContent = 'Copy';
                }, 2000);
            });
        }
        
        function updateApiExamples() {
            // Get form values
            const symbols = Array.from(document.querySelectorAll('#symbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const startDate = document.getElementById('startDate')?.value || '';
            const endDate = document.getElementById('endDate')?.value || '';
            
            // Get selected algorithm from radio buttons
            const algorithmRadio = document.querySelector('input[name="algorithm"]:checked');
            const modelType = algorithmRadio ? algorithmRadio.value : 'xgboost';
            
            const numSamplesInput = document.getElementById('numSamples');
            const numSamples = numSamplesInput ? numSamplesInput.value : '50';
            const timeframe = '1m';
            
            // Get backtesting parameters
            const backtestSymbols = Array.from(document.querySelectorAll('#backtestSymbolGrid input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const backtestSelect = document.getElementById('backtestExperiment');
            const backtestExperiment = backtestSelect ? backtestSelect.value : '';
            const initialCapital = parseFloat(document.getElementById('initialCapital')?.value || 100000);
            const commission = parseFloat(document.getElementById('commission')?.value || 0.1) / 100;
            const slippage = parseFloat(document.getElementById('slippage')?.value || 0.05) / 100;
            const backtestTrainMonths = parseInt(document.getElementById('backtestTrainMonths')?.value || 3);
            const backtestTestMonths = parseInt(document.getElementById('backtestTestMonths')?.value || 1);
            const backtestStepMonths = parseInt(document.getElementById('backtestStepMonths')?.value || 1);
            const backtestStartDate = document.getElementById('backtestStartDate')?.value || null;
            const backtestEndDate = document.getElementById('backtestEndDate')?.value || null;
            
            // Generate experiment name
            const primarySymbol = symbols.length > 0 ? symbols[0] : 'GOOGL';
            const experimentName = backtestExperiment || `walk_forward_${modelType}_${primarySymbol}`;
            
            // Debug log
            console.log('Updating API examples:', { symbols, startDate, endDate, modelType, numSamples, experimentName });
            
            // Add visual feedback
            const curlExamples = document.querySelectorAll('.curl-example');
            curlExamples.forEach(elem => elem.classList.add('updating'));
            setTimeout(() => {
                curlExamples.forEach(elem => elem.classList.remove('updating'));
            }, 300);
            
            // Update Training curl
            const trainPayload = {
                symbols: symbols.length > 0 ? symbols : ['GOOGL'],
                model_type: modelType,
                start_date: startDate || '2024-01-01',
                end_date: endDate || '2024-12-31',
                num_samples: parseInt(numSamples) || 50
            };
            
            const trainElem = document.getElementById('trainCurl');
            if (trainElem) {
                trainElem.textContent = 
`curl -X POST http://localhost:8265/train/walk-forward \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(trainPayload, null, 2)}'`;
            }
            
            // Update Folds curl (extracts symbol from model selection)
            // backtestSelect already declared above
            const selectedModel = backtestSelect ? backtestSelect.value : '';
            let foldSymbol = 'AAPL';  // Default
            
            if (selectedModel) {
                // Extract symbol from model name (e.g., "walk_forward_xgboost_AAPL" -> "AAPL")
                const parts = selectedModel.split('_');
                if (parts.length >= 3) {
                    foldSymbol = parts[parts.length - 1];
                }
            }
            
            const foldsPayload = {
                symbol: foldSymbol,
                start_date: backtestStartDate || startDate || '2020-01-01',
                end_date: backtestEndDate || endDate || '2024-12-31',
                train_months: backtestTrainMonths,
                test_months: backtestTestMonths,
                step_months: backtestStepMonths
            };
            
            const foldsElem = document.getElementById('foldsCurl');
            if (foldsElem) {
                foldsElem.textContent = 
`curl -X POST http://localhost:8265/streaming/generate-folds \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(foldsPayload, null, 2)}'`;
            }
            
            // Update Backtest curl
            const backtestPayload = {
                experiment_name: experimentName,
                symbols: backtestSymbols.length > 0 ? backtestSymbols : null,
                train_months: backtestTrainMonths,
                test_months: backtestTestMonths,
                step_months: backtestStepMonths,
                start_date: backtestStartDate,
                end_date: backtestEndDate,
                initial_capital: initialCapital,
                commission: commission,
                slippage: slippage
            };
            
            const backtestElem = document.getElementById('backtestCurl');
            if (backtestElem) {
                backtestElem.textContent = 
`curl -X POST http://localhost:8265/backtest/validate \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(backtestPayload, null, 2)}'`;
            }
            
            // Update Results curl
            const resultsElem = document.getElementById('resultsCurl');
            if (resultsElem) {
                resultsElem.textContent = 
`curl -X GET http://localhost:8265/backtest/results/${experimentName}`;
            }
        }
        
        // ============================================================================
        // Fold Inspector Functions
        // ============================================================================
        
        async function loadFoldsList() {
            const symbol = document.getElementById('inspectSymbol').value.trim().toUpperCase();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }
            
            const listContainer = document.getElementById('foldsListContainer');
            const foldsList = document.getElementById('foldsList');
            const detailsContainer = document.getElementById('foldDetailsContainer');
            
            try {
                foldsList.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
                listContainer.style.display = 'block';
                detailsContainer.style.display = 'none';
                
                const response = await fetch(`/folds/list/${symbol}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        foldsList.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #666;">
                                <div style="font-size: 2em; margin-bottom: 10px;">üìÇ</div>
                                <p>No folds found for ${symbol}</p>
                                <p style="font-size: 0.9em;">Run preprocessing first: POST /streaming/generate-folds</p>
                            </div>
                        `;
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.num_folds === 0) {
                    foldsList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <p>No folds available for ${symbol}</p>
                        </div>
                    `;
                    return;
                }
                
                // Display fold list
                let html = `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #667eea;">
                        <strong>${data.num_folds} folds available</strong> for ${symbol}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                `;
                
                data.folds.forEach((fold, idx) => {
                    html += `
                        <div style="
                            padding: 15px;
                            background: white;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            cursor: pointer;
                            transition: all 0.2s;
                        " 
                        onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.2)'"
                        onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                        onclick="loadFoldDetails('${symbol}', ${fold.fold_id})">
                            <div style="font-weight: 600; font-size: 1.1em; color: #667eea; margin-bottom: 5px;">
                                Fold ${fold.fold_id}
                            </div>
                            <div style="font-size: 0.85em; color: #666;">
                                Click to view columns
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                foldsList.innerHTML = html;
                
            } catch (error) {
                foldsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc2626;">
                        <p>Error loading folds: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadFoldDetails(symbol, foldId) {
            const detailsContainer = document.getElementById('foldDetailsContainer');
            const detailsDiv = document.getElementById('foldDetails');
            
            try {
                detailsDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading fold details...</div>';
                detailsContainer.style.display = 'block';
                
                const response = await fetch(`/folds/${symbol}/${foldId}/columns`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Display column summary
                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Fold ${foldId} Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.9em;">
                            <div><strong>Total Columns:</strong> ${data.total_columns}</div>
                            <div><strong>Context Features:</strong> ${data.column_categories.context_features.length}</div>
                            <div><strong>Indicators:</strong> ${data.column_categories.indicators.length}</div>
                            <div><strong>Price Features:</strong> ${data.column_categories.price_features.length}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: #333;">Column Categories</h4>
                        
                        ${renderColumnCategory('Context Features', data.column_categories.context_features, '#10b981')}
                        ${renderColumnCategory('Technical Indicators', data.column_categories.indicators, '#667eea')}
                        ${renderColumnCategory('Price Features', data.column_categories.price_features, '#f59e0b')}
                        ${renderColumnCategory('Metadata', data.column_categories.metadata, '#6b7280')}
                        ${data.column_categories.other.length > 0 ? renderColumnCategory('Other', data.column_categories.other, '#8b5cf6') : ''}
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #333;">All Columns (${data.columns.length})</h4>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: #f9fafb; z-index: 10;">
                                    <tr>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">Column</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">Type</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">Min</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">Max</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">Mean</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.columns.forEach((col, idx) => {
                    const isContext = data.column_categories.context_features.includes(col.name);
                    const bgColor = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    const contextMarker = isContext ? '<span style="color: #10b981; margin-left: 5px;">üåê</span>' : '';
                    
                    html += `
                        <tr style="background: ${bgColor};">
                            <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-family: monospace;">
                                ${col.name}${contextMarker}
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; color: #6b7280;">${col.dtype}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right; font-family: monospace;">
                                ${col.min !== null && col.min !== undefined ? col.min.toFixed(4) : '-'}
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right; font-family: monospace;">
                                ${col.max !== null && col.max !== undefined ? col.max.toFixed(4) : '-'}
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right; font-family: monospace;">
                                ${col.mean !== null && col.mean !== undefined ? col.mean.toFixed(4) : '-'}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                detailsDiv.innerHTML = html;
                
                // Scroll to details
                detailsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
            } catch (error) {
                detailsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc2626;">
                        <p>Error loading fold details: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderColumnCategory(title, columns, color) {
            if (columns.length === 0) return '';
            
            return `
                <div style="margin-bottom: 15px; padding: 12px; background: white; border-left: 4px solid ${color}; border-radius: 4px;">
                    <div style="font-weight: 600; color: ${color}; margin-bottom: 8px;">
                        ${title} (${columns.length})
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${columns.map(col => `
                            <span style="
                                padding: 4px 8px;
                                background: #f3f4f6;
                                border-radius: 4px;
                                font-size: 0.8em;
                                font-family: monospace;
                                color: #374151;
                            ">${col}</span>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // ============================================================================
        // End Fold Inspector Functions
        // ============================================================================
        
        // Update API examples whenever form changes
        document.addEventListener('DOMContentLoaded', () => {
            // Add listeners to all form elements for real-time updates
            const addUpdateListener = (id) => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.addEventListener('change', updateApiExamples);
                    elem.addEventListener('input', updateApiExamples);
                }
            };
            
            // Listen to all key form inputs
            addUpdateListener('startDate');
            addUpdateListener('endDate');
            addUpdateListener('numSamples');
            addUpdateListener('trainMonths');
            addUpdateListener('testMonths');
            addUpdateListener('stepMonths');
            addUpdateListener('skipEmptyFolds');
            addUpdateListener('windows');
            addUpdateListener('resamplingTimeframes');
            
            // Listen to algorithm radio buttons
            const algorithmRadios = document.querySelectorAll('input[name="algorithm"]');
            algorithmRadios.forEach(radio => {
                radio.addEventListener('change', updateApiExamples);
            });
            
            // Listen to backtesting parameters
            addUpdateListener('backtestExperiment');
            addUpdateListener('initialCapital');
            addUpdateListener('commission');
            addUpdateListener('slippage');
            addUpdateListener('backtestTrainMonths');
            addUpdateListener('backtestTestMonths');
            addUpdateListener('backtestStepMonths');
            addUpdateListener('backtestStartDate');
            addUpdateListener('backtestEndDate');
        }); // End DOMContentLoaded
        
        // ============================================================================
        // Retrain Workflow Functions
        // ============================================================================
        
        let selectedModel = null;
        let modelFeatures = null;
        
        async function showRetrainWorkflow() {
            document.getElementById('retrainModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            await loadModelsList();
        }
        
        function closeRetrainWorkflow() {
            document.getElementById('retrainModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            selectedModel = null;
            modelFeatures = null;
            showRetrainStep(1);
        }
        
        function showRetrainStep(step) {
            document.getElementById('retrainStep1').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('retrainStep2').style.display = step === 2 ? 'block' : 'none';
        }
        
        async function loadModelsList() {
            const loadingEl = document.getElementById('modelListLoading');
            const containerEl = document.getElementById('modelListContainer');
            const tableBody = document.getElementById('modelListTable');
            
            loadingEl.style.display = 'block';
            containerEl.style.display = 'none';
            
            try {
                const response = await fetch('/models/list');
                const data = await response.json();
                
                if (!data.models || data.models.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">No trained models found. Train a model first.</td></tr>';
                } else {
                    tableBody.innerHTML = data.models.map((model, idx) => {
                        const r2Display = model.avg_test_r2 != null ? model.avg_test_r2.toFixed(4) : 'N/A';
                        const rmseDisplay = model.avg_test_rmse != null ? model.avg_test_rmse.toFixed(6) : 'N/A';
                        const contextDisplay = model.context_symbols && model.context_symbols.length > 0 
                            ? model.context_symbols.join(', ') 
                            : 'None';
                        const dateDisplay = new Date(model.created_at).toLocaleString();
                        
                        const r2Color = model.avg_test_r2 > 0.5 ? '#28a745' : (model.avg_test_r2 > 0.2 ? '#ffc107' : '#dc3545');
                        
                        return `
                            <tr style="border-bottom: 1px solid #e5e7eb; cursor: pointer;" 
                                onclick="selectModelRow(${idx}, ${JSON.stringify(model).replace(/"/g, '&quot;')})"
                                id="modelRow${idx}">
                                <td style="padding: 12px;">
                                    <input type="radio" name="selectedModel" value="${idx}" 
                                        onchange="selectModelRow(${idx}, ${JSON.stringify(model).replace(/"/g, '&quot;')})">
                                </td>
                                <td style="padding: 12px;">
                                    <span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: bold;">
                                        ${model.algorithm.toUpperCase()}
                                    </span>
                                </td>
                                <td style="padding: 12px; font-weight: bold;">${model.ticker}</td>
                                <td style="padding: 12px; text-align: center;">${model.num_features}</td>
                                <td style="padding: 12px; text-align: center;">${model.num_folds}</td>
                                <td style="padding: 12px; text-align: center; color: ${r2Color}; font-weight: bold;">${r2Display}</td>
                                <td style="padding: 12px; text-align: center;">${rmseDisplay}</td>
                                <td style="padding: 12px; font-size: 0.85em;">${contextDisplay}</td>
                                <td style="padding: 12px; font-size: 0.85em;">${dateDisplay}</td>
                            </tr>
                        `;
                    }).join('');
                }
                
                loadingEl.style.display = 'none';
                containerEl.style.display = 'block';
            } catch (error) {
                console.error('Error loading models:', error);
                tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">Error loading models: ${error.message}</td></tr>`;
                loadingEl.style.display = 'none';
                containerEl.style.display = 'block';
            }
        }
        
        function selectModelRow(idx, model) {
            // Highlight selected row
            document.querySelectorAll('#modelListTable tr').forEach(row => {
                row.style.background = '';
            });
            document.getElementById(`modelRow${idx}`).style.background = '#e7f3ff';
            
            // Check the radio button
            document.querySelectorAll('input[name="selectedModel"]')[idx].checked = true;
            
            selectedModel = model;
        }
        
        async function loadModelDetails() {
            if (!selectedModel) {
                alert('Please select a model first');
                return;
            }
            
            showRetrainStep(2);
            
            // Display model info summary
            const contextSymbols = selectedModel.context_symbols && selectedModel.context_symbols.length > 0 
                ? selectedModel.context_symbols.join(', ') 
                : 'None';
            
            document.getElementById('selectedModelInfo').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div><strong>Algorithm:</strong> ${selectedModel.algorithm.toUpperCase()}</div>
                    <div><strong>Ticker:</strong> ${selectedModel.ticker}</div>
                    <div><strong>Test R¬≤:</strong> <span style="color: ${selectedModel.avg_test_r2 > 0.5 ? '#28a745' : '#ffc107'};">${(selectedModel.avg_test_r2 || 0).toFixed(4)}</span></div>
                    <div><strong>Test RMSE:</strong> ${(selectedModel.avg_test_rmse || 0).toFixed(6)}</div>
                    <div><strong>Folds:</strong> ${selectedModel.num_folds}</div>
                    <div><strong>Features:</strong> ${selectedModel.num_features}</div>
                    <div><strong>Context:</strong> ${contextSymbols}</div>
                    <div><strong>Train Period:</strong> ${selectedModel.train_months || 'N/A'}m</div>
                    <div><strong>Test Period:</strong> ${selectedModel.test_months || 'N/A'}m</div>
                </div>
            `;
            
            // Display configuration
            const configDisplay = document.getElementById('retrainConfigDisplay');
            const config = selectedModel.config || {};
            const params = selectedModel.params || {};
            
            const allParams = {...config, ...params};
            configDisplay.innerHTML = Object.entries(allParams)
                .filter(([key]) => !key.startsWith('top_feature_') && !key.startsWith('pbt_'))
                .map(([key, value]) => {
                    const displayValue = typeof value === 'number' ? value.toFixed(4) : value;
                    return `
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <div style="font-size: 0.85em; color: #6c757d; margin-bottom: 4px;">${key}</div>
                            <div style="font-weight: bold;">${displayValue}</div>
                        </div>
                    `;
                }).join('');
            
            // Load feature importance
            await loadFeatureImportance();
        }
        
        async function loadFeatureImportance() {
            const loadingEl = document.getElementById('featureSelectionLoading');
            const gridEl = document.getElementById('featureSelectionGrid');
            const summaryEl = document.getElementById('featureSelectionSummary');
            
            loadingEl.style.display = 'block';
            gridEl.style.display = 'none';
            summaryEl.style.display = 'none';
            
            try {
                const response = await fetch(`/models/${selectedModel.experiment_id}/${selectedModel.trial_id}/features`);
                const data = await response.json();
                
                modelFeatures = data.feature_importance;
                const medianImportance = data.summary.median_importance;
                
                document.getElementById('medianImportanceValue').textContent = medianImportance.toFixed(6);
                
                const tableBody = document.getElementById('featureTableBody');
                tableBody.innerHTML = modelFeatures.map((feat, idx) => {
                    const isLowImportance = feat.is_low_importance;
                    const checked = !isLowImportance; // Uncheck low importance by default
                    const statusBadge = isLowImportance 
                        ? '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">Low</span>'
                        : '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">High</span>';
                    
                    const rowStyle = isLowImportance ? 'background: #fff3cd;' : '';
                    
                    return `
                        <tr style="${rowStyle} border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 12px; text-align: center;">
                                <input type="checkbox" 
                                    class="feature-checkbox" 
                                    data-feature="${feat.name}"
                                    data-importance="${feat.importance}"
                                    ${checked ? 'checked' : ''}
                                    onchange="updateFeatureSelectionSummary()">
                            </td>
                            <td style="padding: 12px; font-family: monospace; font-size: 0.9em;">${feat.name}</td>
                            <td style="padding: 12px; text-align: center; font-weight: bold;">${feat.importance.toFixed(6)}</td>
                            <td style="padding: 12px; text-align: center;">#${idx + 1}</td>
                            <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                        </tr>
                    `;
                }).join('');
                
                loadingEl.style.display = 'none';
                gridEl.style.display = 'block';
                summaryEl.style.display = 'block';
                
                updateFeatureSelectionSummary();
            } catch (error) {
                console.error('Error loading features:', error);
                loadingEl.innerHTML = `
                    <div style="color: #dc3545; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">‚ùå</div>
                        Error loading features: ${error.message}
                    </div>
                `;
            }
        }
        
        function updateFeatureSelectionSummary() {
            const checkboxes = document.querySelectorAll('.feature-checkbox');
            const total = checkboxes.length;
            const selected = Array.from(checkboxes).filter(cb => cb.checked).length;
            const excluded = total - selected;
            
            document.getElementById('totalFeatureCount').textContent = total;
            document.getElementById('selectedFeatureCount').textContent = selected;
            document.getElementById('excludedFeatureCount').textContent = excluded;
        }
        
        function selectAllFeatures() {
            document.querySelectorAll('.feature-checkbox').forEach(cb => cb.checked = true);
            updateFeatureSelectionSummary();
        }
        
        function deselectAllFeatures() {
            document.querySelectorAll('.feature-checkbox').forEach(cb => cb.checked = false);
            updateFeatureSelectionSummary();
        }
        
        function selectHighImportanceOnly() {
            document.querySelectorAll('.feature-checkbox').forEach(cb => {
                const row = cb.closest('tr');
                const isLowImportance = row.style.background.includes('fff3cd');
                cb.checked = !isLowImportance;
            });
            updateFeatureSelectionSummary();
        }
        
        async function submitRetrain() {
            if (!selectedModel || !modelFeatures) {
                alert('Model or features not loaded');
                return;
            }
            
            // Get excluded features (unchecked boxes)
            const checkboxes = document.querySelectorAll('.feature-checkbox');
            const excludedFeatures = Array.from(checkboxes)
                .filter(cb => !cb.checked)
                .map(cb => cb.dataset.feature);
            
            if (excludedFeatures.length === checkboxes.length) {
                alert('You must select at least one feature for training!');
                return;
            }
            
            // Build training request from original model config
            const trainRequest = {
                symbols: [selectedModel.ticker],
                context_symbols: selectedModel.context_symbols || [],
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                train_months: selectedModel.train_months || 3,
                test_months: selectedModel.test_months || 1,
                step_months: 1,
                algorithm: selectedModel.algorithm,
                param_space: selectedModel.params || null,
                num_samples: 50,
                windows: [50, 200],
                resampling_timeframes: null,
                excluded_features: excludedFeatures,
                base_experiment_id: selectedModel.experiment_id
            };
            
            const submitBtn = document.getElementById('retrainSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Starting Retrain...';
            
            try {
                const response = await fetch('/train/walk_forward', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(trainRequest)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Retrain started successfully!\\n\\nJob ID: ${result.job_id}\\n\\nExcluded ${excludedFeatures.length} low-importance features.\\n\\nCheck Ray Dashboard for progress.`);
                    closeRetrainWorkflow();
                } else {
                    alert(`‚ùå Error starting retrain: ${result.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error submitting retrain:', error);
                alert(`‚ùå Error submitting retrain: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Start Retraining with Selected Features';
            }
        }
        
        // ========================================================================
        // Rank Models Dialog
        // ========================================================================
        
        async function showRankModelsDialog() {
            document.getElementById('rankModelsModal').style.display = 'block';
            document.getElementById('rankResults').style.display = 'none';
            
            // Load experiment names
            await loadExperimentNames();
        }
        
        async function loadExperimentNames() {
            const select = document.getElementById('rankExperimentName');
            select.innerHTML = '<option value="">-- Loading... --</option>';
            
            try {
                console.log('Fetching experiments...');
                const response = await fetch('/experiments');
                const data = await response.json();
                
                console.log('Experiments response:', response.ok, data);
                console.log('Experiments array:', data.experiments);
                console.log('Experiments length:', data.experiments ? data.experiments.length : 0);
                
                if (response.ok && data.experiments && data.experiments.length > 0) {
                    console.log('Populating dropdown with', data.experiments.length, 'experiments');
                    select.innerHTML = '<option value="">-- Select an experiment --</option>' +
                        data.experiments.map(exp => 
                            `<option value="${exp.name}">${exp.name}</option>`
                        ).join('');
                    console.log('Dropdown HTML:', select.innerHTML.substring(0, 200));
                } else {
                    console.log('No experiments condition triggered');
                    select.innerHTML = '<option value="">No experiments found</option>';
                }
            } catch (error) {
                console.error('Error loading experiments:', error);
                select.innerHTML = '<option value="">Error loading experiments</option>';
            }
        }
        
        function closeRankModelsDialog() {
            document.getElementById('rankModelsModal').style.display = 'none';
        }
        
        async function rankModels() {
            const experimentName = document.getElementById('rankExperimentName').value.trim();
            const metric = document.getElementById('rankMetric').value;
            const topN = parseInt(document.getElementById('rankTopN').value);
            
            if (!experimentName) {
                alert('‚ö†Ô∏è Please enter an experiment name');
                return;
            }
            
            const btn = document.getElementById('rankModelsBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Ranking models...';
            
            try {
                // Determine if ascending (lower is better for RMSE/MAE, higher for R¬≤ and balanced)
                const ascending = metric.includes('rmse') || metric.includes('mae');
                
                const response = await fetch(`/models/rank?experiment_name=${encodeURIComponent(experimentName)}&metric=${metric}&top_n=${topN}&ascending=${ascending}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Show results
                    document.getElementById('rankResults').style.display = 'block';
                    
                    let html = `
                        <p style="margin-bottom: 15px;">
                            <strong>Experiment:</strong> ${result.experiment_name}<br>
                            <strong>Ranked by:</strong> ${result.metric}<br>
                            <strong>Total models tagged:</strong> ${result.total_ranked}
                        </p>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #e9ecef;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Rank</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Trial ID</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Trial Name</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Score</th>
                                    ${result.metric === 'balanced_performance' 
                                        ? '<th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Test R¬≤</th><th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Overfitting Gap</th>' 
                                        : '<th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Test R¬≤</th><th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Test RMSE</th><th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Train RMSE</th><th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Overfitting Gap</th>'}
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Tags</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    result.models.forEach(model => {
                        const tags = [];
                        if (model.rank <= 3) tags.push('<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">üèÜ Production Candidate</span>');
                        tags.push(`<span style="background: #ffc107; color: #333; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">Top ${topN}</span>`);
                        
                        const compositeColumns = result.metric === 'balanced_performance' 
                            ? `<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${(model.test_r2 || 0).toFixed(4)}</td>
                               <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${(model.overfitting_gap || 0).toFixed(6)}</td>`
                            : `<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${(model.test_r2 || 0).toFixed(4)}</td>
                               <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${(model.test_rmse || 0).toFixed(6)}</td>
                               <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${(model.train_rmse || 0).toFixed(6)}</td>
                               <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${(model.overfitting_gap || 0).toFixed(6)}</td>`;
                        
                        html += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>#${model.rank}</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 0.9em;">${model.trial_id || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${model.run_name || model.trial_dir}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${model.value.toFixed(6)}</td>
                                ${compositeColumns}
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${tags.join(' ')}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <button onclick="selectModelForRetrain('${result.experiment_name}', '${model.trial_dir}', ${model.rank})" 
                                            style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                                        üìù Select for Retrain
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                        <p style="margin-top: 15px; color: #666; font-size: 0.95em;">
                            ‚ÑπÔ∏è Models are now tagged in MLflow with 'model_rank', 'top_${topN}', and 'production_candidate' tags.<br>
                            You can filter by these tags in the MLflow UI.
                        </p>
                    `;
                    
                    document.getElementById('rankResultsContent').innerHTML = html;
                    
                    btn.textContent = '‚úÖ Ranking Complete';
                    setTimeout(() => {
                        btn.textContent = 'üèÜ Rank Models Now';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    alert(`‚ùå Error ranking models: ${result.detail || 'Unknown error'}`);
                    btn.textContent = 'üèÜ Rank Models Now';
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error ranking models:', error);
                alert(`‚ùå Error ranking models: ${error.message}`);
                btn.textContent = 'üèÜ Rank Models Now';
                btn.disabled = false;
            }
        }
        
        // Feature Selection & Retrain Functions
        let selectedModelData = null;
        let originalExperimentName = null;
        
        async function selectModelForRetrain(experimentName, trialDir, rank) {
            try {
                // Store original experiment name for lineage
                originalExperimentName = experimentName;
                
                // Fetch trial details and feature importance
                const response = await fetch(`/models/trial-details?experiment_name=${experimentName}&trial_dir=${encodeURIComponent(trialDir)}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to load trial details');
                }
                
                selectedModelData = data;
                
                // Display model info
                document.getElementById('selectedModelInfo').innerHTML = `
                    <h4 style="margin-top: 0;">Selected Model: Rank #${rank}</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.95em;">
                        <div><strong>Original Experiment:</strong> ${experimentName}</div>
                        <div><strong>Trial:</strong> ${trialDir}</div>
                        <div><strong>Primary Symbol:</strong> ${data.config.primary_ticker || 'N/A'}</div>
                        <div><strong>Algorithm:</strong> ${data.config.algorithm || 'N/A'}</div>
                        <div><strong>Test R¬≤:</strong> ${(data.metrics.test_r2 || 0).toFixed(4)}</div>
                        <div><strong>Features Used:</strong> ${data.feature_importance ? data.feature_importance.length : 0}</div>
                    </div>
                `;
                
                // Display feature importance with checkboxes
                displayFeatureImportance(data.feature_importance || []);
                
                // Show modal
                document.getElementById('featureSelectionModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error selecting model:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        function displayFeatureImportance(features) {
            const autoFilter = document.getElementById('autoFilterLowImportance').checked;
            const threshold = 0.0001;
            
            if (!features || features.length === 0) {
                document.getElementById('featureList').innerHTML = '<p style="color: #666;">No feature importance data available for this model.</p>';
                return;
            }
            
            // Sort by importance descending
            features.sort((a, b) => b.importance - a.importance);
            
            let html = '<div style="display: grid; gap: 8px;">';
            features.forEach((feature, idx) => {
                const isLowImportance = feature.importance < threshold;
                const checked = autoFilter ? !isLowImportance : true;
                const opacity = isLowImportance ? 'opacity: 0.5;' : '';
                
                html += `
                    <label style="display: flex; align-items: center; padding: 8px; background: ${idx % 2 === 0 ? '#f8f9fa' : 'white'}; border-radius: 4px; ${opacity}">
                        <input type="checkbox" 
                               class="feature-checkbox" 
                               data-feature="${feature.feature}" 
                               data-importance="${feature.importance}"
                               ${checked ? 'checked' : ''}
                               style="margin-right: 10px;">
                        <span style="flex: 1; font-family: monospace; font-size: 0.9em;">${feature.feature}</span>
                        <span style="color: ${feature.importance >= threshold ? '#28a745' : '#6c757d'}; font-weight: bold; margin-left: 10px;">
                            ${feature.importance.toFixed(6)}
                        </span>
                    </label>
                `;
            });
            html += '</div>';
            
            document.getElementById('featureList').innerHTML = html;
        }
        
        function closeFeatureSelectionDialog() {
            document.getElementById('featureSelectionModal').style.display = 'none';
            selectedModelData = null;
        }
        
        function toggleAutoFilter() {
            if (selectedModelData && selectedModelData.feature_importance) {
                displayFeatureImportance(selectedModelData.feature_importance);
            }
        }
        
        function selectAllFeatures() {
            document.querySelectorAll('.feature-checkbox').forEach(cb => cb.checked = true);
        }
        
        function deselectAllFeatures() {
            document.querySelectorAll('.feature-checkbox').forEach(cb => cb.checked = false);
        }
        
        async function trainWithSelectedFeatures() {
            if (!selectedModelData) {
                alert('No model selected');
                return;
            }
            
            // Get selected features
            const selectedFeatures = Array.from(document.querySelectorAll('.feature-checkbox:checked'))
                .map(cb => cb.dataset.feature);
            
            if (selectedFeatures.length === 0) {
                alert('Please select at least one feature');
                return;
            }
            
            // Get form values
            const primaryTicker = document.getElementById('retrainTicker').value.trim();
            const contextSymbolsStr = document.getElementById('retrainContext').value.trim();
            const contextSymbols = contextSymbolsStr ? contextSymbolsStr.split(',').map(s => s.trim()) : [];
            const startDate = document.getElementById('retrainStartDate').value;
            const endDate = document.getElementById('retrainEndDate').value;
            const trainMonths = parseInt(document.getElementById('retrainTrainMonths').value);
            const testMonths = parseInt(document.getElementById('retrainTestMonths').value);
            const stepMonths = parseInt(document.getElementById('retrainStepMonths').value);
            const numSamples = parseInt(document.getElementById('retrainNumSamples').value);
            
            // Validate
            if (!primaryTicker) {
                alert('Please enter a primary ticker');
                return;
            }
            if (!startDate || !endDate) {
                alert('Please enter start and end dates');
                return;
            }
            
            const btn = document.getElementById('retrainBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Submitting Training Job...';
            
            try {
                // Create new experiment name with lineage from original
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const newExperimentName = `${originalExperimentName}_retrain_${timestamp}`;
                
                // Submit new training job with form values
                const trainingConfig = {
                    primary_ticker: primaryTicker,
                    context_tickers: contextSymbols,
                    algorithm: selectedModelData.config.algorithm || 'xgboost',
                    selected_features: selectedFeatures,
                    start_date: startDate,
                    end_date: endDate,
                    train_months: trainMonths,
                    test_months: testMonths,
                    step_months: stepMonths,
                    windows: [5, 10, 20, 60],
                    resampling_timeframes: ['1min', '5min', '15min', '30min', '1h', '4h', '1d'],
                    hyperparameters: {},
                    num_samples: numSamples,
                    experiment_name: newExperimentName,
                    parent_experiment: originalExperimentName,
                    parent_trial: selectedModelData.trial_dir
                };
                
                const response = await fetch('/training/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(trainingConfig)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Get Ray Dashboard URL based on current environment
                    const rayDashboardUrl = window.location.hostname === 'localhost' 
                        ? `http://localhost:8265/#/jobs/${result.job_id}`
                        : `https://${window.location.hostname.replace('-8100', '-8265')}/#/jobs/${result.job_id}`;
                    
                    const message = `‚úÖ Training job submitted successfully!\n\n` +
                                  `Experiment: ${trainingConfig.experiment_name}\n` +
                                  `Job ID: ${result.job_id}\n` +
                                  `Features: ${selectedFeatures.length} selected, ${result.features_excluded} excluded\n\n` +
                                  `View progress at:\n${rayDashboardUrl}`;
                    alert(message);
                    
                    // Open Ray Dashboard in new tab
                    window.open(rayDashboardUrl, '_blank');
                    
                    closeFeatureSelectionDialog();
                } else {
                    throw new Error(result.detail || 'Training submission failed');
                }
            } catch (error) {
                console.error('Error submitting training:', error);
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Train New Model with Selected Features';
            }
        }
    </script>
</body>
</html>
