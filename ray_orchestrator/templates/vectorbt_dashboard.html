<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VectorBT Backtest Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        .control-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        
        select, input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 10px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: flex-end;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        .metric-value.positive {
            color: #10b981;
        }
        
        .metric-value.negative {
            color: #ef4444;
        }
        
        .chart-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 40px;
        }
        
        .error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 20px;
            color: #991b1b;
            margin-bottom: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä VectorBT Backtest Dashboard</h1>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/" style="
                display: inline-block;
                padding: 8px 16px;
                background: rgba(255,255,255,0.2);
                color: white;
                text-decoration: none;
                border-radius: 6px;
                margin-right: 10px;
                transition: background 0.3s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'"
               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                ‚Üê Training Dashboard
            </a>
            <a href="/backtest/results_viewer" style="
                display: inline-block;
                padding: 8px 16px;
                background: rgba(255,255,255,0.2);
                color: white;
                text-decoration: none;
                border-radius: 6px;
                transition: background 0.3s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'"
               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                Results Viewer ‚Üí
            </a>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="symbolSelect">Symbol</label>
                    <select id="symbolSelect">
                        <option value="">Select Symbol...</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="modelSelect">Model</label>
                    <select id="modelSelect">
                        <option value="">Select Model...</option>
                    </select>
                </div>
                
                <button onclick="loadBacktestResults()">Load Results</button>
                <button onclick="refreshData()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Refresh</button>
            </div>
        </div>
        
        <div id="error-container"></div>
        
        <div id="dashboard-content">
            <div class="empty-state">
                <h2>Select a symbol and model to view backtest results</h2>
                <p>Use the controls above to load your VectorBT backtest analysis</p>
            </div>
        </div>
    </div>
    
    <script>
        let backtestData = null;
        
        // Load available symbols and models on page load
        async function initializeDashboard() {
            try {
                // Load symbols
                const statusResp = await fetch('/streaming/status');
                const status = await statusResp.json();
                
                const symbolSelect = document.getElementById('symbolSelect');
                // status.data_sources.symbols is an array of {symbol, file_count, date_range}
                const symbols = status.data_sources?.symbols || [];
                symbols.forEach(symbolInfo => {
                    const option = document.createElement('option');
                    option.value = symbolInfo.symbol;
                    option.textContent = `${symbolInfo.symbol} (${symbolInfo.date_range.start} to ${symbolInfo.date_range.end})`;
                    symbolSelect.appendChild(option);
                });
                
                // Load models (list trained models)
                const modelsResp = await fetch('/list_trained_models');
                if (modelsResp.ok) {
                    const models = await modelsResp.json();
                    const modelSelect = document.getElementById('modelSelect');
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = `${model.symbol} - ${model.algorithm} (${model.date})`;
                        option.dataset.symbol = model.symbol; // Store symbol for auto-selection
                        modelSelect.appendChild(option);
                    });
                    
                    // Auto-select symbol when model changes
                    modelSelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption && selectedOption.dataset.symbol) {
                            symbolSelect.value = selectedOption.dataset.symbol;
                            // Highlight that symbol was auto-selected
                            symbolSelect.style.background = '#e0f2fe';
                            setTimeout(() => {
                                symbolSelect.style.background = '';
                            }, 1000);
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                showError('Failed to load symbols and models: ' + error.message);
            }
        }
        
        async function loadBacktestResults() {
            const symbol = document.getElementById('symbolSelect').value;
            const model = document.getElementById('modelSelect').value;
            
            if (!symbol || !model) {
                showError('Please select both a symbol and model');
                return;
            }
            
            clearError();
            showLoading();
            
            try {
                const response = await fetch(`/backtest/results?model=${encodeURIComponent(model)}&symbol=${encodeURIComponent(symbol)}`);
                
                if (!response.ok) {
                    if (response.status === 404 || response.status === 500) {
                        // No results found - offer to run backtest
                        showNoResults(model, symbol);
                        return;
                    }
                    throw new Error(`Failed to load results: ${response.statusText}`);
                }
                
                backtestData = await response.json();
                renderDashboard();
            } catch (error) {
                showError(error.message);
            }
        }
        
        function showNoResults(model, symbol) {
            const content = document.getElementById('dashboard-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üìä</div>
                    <h2 style="color: #333; margin-bottom: 20px;">No Backtest Results Found</h2>
                    <p style="color: #666; font-size: 1.1em; margin-bottom: 30px;">
                        Model <strong>${model}</strong> hasn't been backtested yet.<br>
                        Run a backtest first to see the results here.
                    </p>
                    <div style="background: #f0f9ff; border: 2px solid #0284c7; border-radius: 10px; padding: 20px; margin: 20px auto; max-width: 600px;">
                        <h3 style="color: #0284c7; margin-bottom: 15px;">How to Run Backtest:</h3>
                        <ol style="text-align: left; color: #555; line-height: 1.8;">
                            <li>Go to the <a href="/" style="color: #667eea; font-weight: 600;">Training Dashboard</a></li>
                            <li>Scroll to the "VectorBT Backtesting" section</li>
                            <li>Select model: <strong>${model}</strong></li>
                            <li>Select symbol: <strong>${symbol}</strong></li>
                            <li>Click "Run Backtest"</li>
                            <li>Wait for completion (~1-5 minutes)</li>
                            <li>Return here and click "Load Results"</li>
                        </ol>
                    </div>
                    <a href="/" style="
                        display: inline-block;
                        padding: 15px 30px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        text-decoration: none;
                        border-radius: 8px;
                        font-weight: 600;
                        font-size: 1.1em;
                        margin-top: 20px;
                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                    ">Go to Training Dashboard</a>
                </div>
            `;
        }
        
        function renderDashboard() {
            if (!backtestData || !backtestData.aggregate_metrics) {
                showError('No backtest data available');
                return;
            }
            
            const content = document.getElementById('dashboard-content');
            const metrics = backtestData.aggregate_metrics;
            const foldResults = backtestData.fold_results || [];
            
            content.innerHTML = `
                <!-- Summary Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Avg Return</div>
                        <div class="metric-value ${metrics.avg_return > 0 ? 'positive' : 'negative'}">
                            ${(metrics.avg_return * 100).toFixed(2)}%
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Sharpe Ratio</div>
                        <div class="metric-value ${metrics.avg_sharpe > 0 ? 'positive' : 'negative'}">
                            ${metrics.avg_sharpe.toFixed(2)}
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Avg Max Drawdown</div>
                        <div class="metric-value negative">
                            ${(metrics.avg_max_drawdown * 100).toFixed(2)}%
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value ${metrics.avg_win_rate > 0.5 ? 'positive' : 'negative'}">
                            ${(metrics.avg_win_rate * 100).toFixed(1)}%
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Alpha vs Buy & Hold</div>
                        <div class="metric-value ${metrics.avg_alpha > 0 ? 'positive' : 'negative'}">
                            ${(metrics.avg_alpha * 100).toFixed(2)}%
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-value">
                            ${metrics.total_trades.toLocaleString()}
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Profitable Folds</div>
                        <div class="metric-value">
                            ${metrics.profitable_folds} / ${metrics.num_folds}
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Return Consistency</div>
                        <div class="metric-value ${metrics.return_consistency_score > 0.7 ? 'positive' : ''}">
                            ${(metrics.return_consistency_score * 100).toFixed(1)}%
                        </div>
                    </div>
                </div>
                
                <!-- Cumulative Returns Chart -->
                <div class="chart-section">
                    <div class="chart-title">Cumulative Returns by Fold</div>
                    <div id="returnsChart"></div>
                </div>
                
                <!-- Returns Distribution -->
                <div class="chart-section">
                    <div class="chart-title">Returns Distribution</div>
                    <div id="distributionChart"></div>
                </div>
                
                <!-- Fold Performance Table -->
                <div class="table-container">
                    <div class="chart-title">Fold-by-Fold Performance</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Fold</th>
                                <th>Total Return</th>
                                <th>Buy & Hold</th>
                                <th>Alpha</th>
                                <th>Sharpe</th>
                                <th>Max DD</th>
                                <th>Win Rate</th>
                                <th>Trades</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${foldResults.map(fold => `
                                <tr>
                                    <td>${fold.fold_id}</td>
                                    <td style="color: ${fold.total_return > 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                        ${(fold.total_return * 100).toFixed(2)}%
                                    </td>
                                    <td>${(fold.buy_hold_return * 100).toFixed(2)}%</td>
                                    <td style="color: ${fold.alpha > 0 ? '#10b981' : '#ef4444'};">
                                        ${(fold.alpha * 100).toFixed(2)}%
                                    </td>
                                    <td>${fold.sharpe_ratio.toFixed(2)}</td>
                                    <td style="color: #ef4444;">${(fold.max_drawdown * 100).toFixed(2)}%</td>
                                    <td>${(fold.win_rate * 100).toFixed(1)}%</td>
                                    <td>${fold.num_trades}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            renderReturnsChart(foldResults);
            renderDistributionChart(foldResults);
        }
        
        function renderReturnsChart(foldResults) {
            const trace1 = {
                x: foldResults.map(f => f.fold_id),
                y: foldResults.map(f => f.total_return * 100),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Strategy Return',
                line: { color: '#667eea', width: 3 },
                marker: { size: 8 }
            };
            
            const trace2 = {
                x: foldResults.map(f => f.fold_id),
                y: foldResults.map(f => f.buy_hold_return * 100),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Buy & Hold',
                line: { color: '#f59e0b', width: 2, dash: 'dash' },
                marker: { size: 6 }
            };
            
            const layout = {
                xaxis: { title: 'Fold Number' },
                yaxis: { title: 'Return (%)' },
                hovermode: 'x unified',
                showlegend: true,
                height: 400
            };
            
            Plotly.newPlot('returnsChart', [trace1, trace2], layout, { responsive: true });
        }
        
        function renderDistributionChart(foldResults) {
            const returns = foldResults.map(f => f.total_return * 100);
            
            const trace = {
                x: returns,
                type: 'histogram',
                nbinsx: 20,
                marker: {
                    color: '#667eea',
                    line: { color: '#764ba2', width: 1 }
                }
            };
            
            const layout = {
                xaxis: { title: 'Return (%)' },
                yaxis: { title: 'Frequency' },
                height: 350
            };
            
            Plotly.newPlot('distributionChart', [trace], layout, { responsive: true });
        }
        
        function showLoading() {
            document.getElementById('dashboard-content').innerHTML = '<div class="loading">Loading backtest results...</div>';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-container');
            errorDiv.innerHTML = `<div class="error">‚ö†Ô∏è ${message}</div>`;
        }
        
        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }
        
        function refreshData() {
            initializeDashboard();
        }
        
        // Initialize on page load
        initializeDashboard();
    </script>
</body>
</html>
