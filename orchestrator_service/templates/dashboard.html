<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="data:,">
  <title>Orchestrator - Recursive Strategy Factory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #1e293b;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --border: #334155;
      --primary: #f59e0b;
      --primary-hover: #d97706;
      --danger: #ef4444;
      --success: #10b981;
      --info: #3b82f6;
    }
    body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; line-height: 1.5; }
    * { box-sizing: border-box; }
    
    .layout { max-width: 1400px; margin: 0 auto; padding: 2rem; display: grid; gap: 2rem; }
    
    header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 600; background: linear-gradient(to right, #f59e0b, #ef4444); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    
    section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
    h2 { margin: 0; font-size: 1.1rem; font-weight: 600; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; color: var(--primary); }
    h3 { margin: 0; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); }
    
    .row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
    .group { display: flex; flex-direction: column; gap: 0.25rem; flex: 1; min-width: 150px; }
    .group.full { flex: 100%; }
    
    label { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
    input, select, textarea { background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text); padding: 0.5rem; border-radius: 4px; outline: none; width: 100%; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }
    
    button { background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    button:hover { background: var(--primary-hover); transform: translateY(-1px); }
    button.secondary { background: var(--border); }
    button.secondary:hover { background: #475569; }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
    th { color: var(--text-muted); font-weight: 600; font-size: 0.85rem; }
    tr:hover { background: rgba(255,255,255,0.02); }
    
    .badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: var(--border); display: inline-block; }
    .badge.completed, .badge.promoted { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .badge.failed { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .badge.running { background: rgba(59, 130, 246, 0.2); color: #60a5fa; animation: pulse 2s infinite; }
    .badge.pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    
    pre { background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 6px; overflow: auto; font-size: 0.85rem; max-height: 300px; }
    code { font-family: 'Fira Code', monospace; }
    
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; }
    
    .stat-card { background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 6px; text-align: center; }
    .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); }
    
    .progress-bar { background: var(--border); border-radius: 4px; height: 8px; overflow: hidden; }
    .progress-fill { background: var(--success); height: 100%; transition: width 0.3s; }
    
    .holy-grail { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3); }
    
    .clickable { cursor: pointer; }
    .clickable:hover { background: rgba(255,255,255,0.05); }
    
    #log-output { font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <div style="display:flex; align-items:center; gap:1rem;">
        <h1>üè≠ Recursive Strategy Factory</h1>
        <span style="color: var(--text-muted); font-size: 0.9rem;">Train ‚Üí Prune ‚Üí Simulate ‚Üí Evolve</span>
      </div>
      <div class="badge">Port: 8400</div>
    </header>

    <!-- Stats Overview -->
    <section>
      <h2>üìä System Status</h2>
      <div class="row" style="justify-content: space-around;">
        <div class="stat-card">
          <div class="stat-value" id="stat-runs">-</div>
          <div class="stat-label">Evolution Runs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-pending">-</div>
          <div class="stat-label">Pending Jobs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-promoted">-</div>
          <div class="stat-label">üèÜ Promoted Models</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-workers">-</div>
          <div class="stat-label">Active Workers</div>
        </div>
      </div>
    </section>

    <div class="grid-2">
      <!-- Start Evolution -->
      <section>
        <h2>üöÄ Start Evolution Run</h2>
        <form id="evolve-form">
          <div class="row">
            <div class="group">
              <label>Seed Model ID (optional)</label>
              <input type="text" id="seed-model-id" placeholder="abc-123-def...">
            </div>
            <div class="group">
              <label>Symbol *</label>
              <input type="text" id="symbol" value="RDDT" required>
            </div>
          </div>
          
          <div class="row">
            <div class="group">
              <label>Algorithm</label>
              <select id="algorithm">
                <option value="RandomForest">Random Forest</option>
                <option value="XGBoost">XGBoost</option>
                <option value="LightGBM">LightGBM</option>
                <option value="ElasticNet">ElasticNet</option>
              </select>
            </div>
            <div class="group">
              <label>Target Column</label>
              <select id="target-col">
                <option value="close">close</option>
                <option value="open">open</option>
                <option value="high">high</option>
                <option value="low">low</option>
              </select>
            </div>
            <div class="group">
              <label>Max Generations</label>
              <input type="number" id="max-generations" value="4" min="1" max="10">
            </div>
          </div>
          
          <div class="row">
            <div class="group">
              <label>Target Transform</label>
              <select id="target-transform">
                <option value="log_return">log_return</option>
                <option value="pct_change">pct_change</option>
                <option value="none">none</option>
              </select>
            </div>
            <div class="group">
              <label>Timeframe</label>
              <select id="timeframe">
                <option value="1m">1 minute</option>
                <option value="5m">5 minutes</option>
                <option value="15m">15 minutes</option>
                <option value="1h">1 hour</option>
              </select>
            </div>
          </div>
          
          <div class="row">
            <div class="group full">
              <label>Thresholds (comma-separated)</label>
              <input type="text" id="thresholds" value="0.0001, 0.0003, 0.0005, 0.0007">
            </div>
          </div>
          
          <details style="margin-top: 0.5rem;">
            <summary>Holy Grail Criteria (Advanced)</summary>
            <div class="row" style="margin-top: 0.5rem;">
              <div class="group">
                <label>SQN Min</label>
                <input type="number" id="sqn-min" value="3.0" step="0.1">
              </div>
              <div class="group">
                <label>SQN Max</label>
                <input type="number" id="sqn-max" value="5.0" step="0.1">
              </div>
              <div class="group">
                <label>PF Min</label>
                <input type="number" id="pf-min" value="2.0" step="0.1">
              </div>
              <div class="group">
                <label>PF Max</label>
                <input type="number" id="pf-max" value="4.0" step="0.1">
              </div>
            </div>
            <div class="row">
              <div class="group">
                <label>Min Trades</label>
                <input type="number" id="trades-min" value="200">
              </div>
              <div class="group">
                <label>Max Trades</label>
                <input type="number" id="trades-max" value="10000">
              </div>
            </div>
          </details>
          
          <button type="submit" style="margin-top: 1rem; width: 100%;">
            üß¨ Start Evolution
          </button>
        </form>
        <div id="evolve-result" style="display: none;"></div>
      </section>

      <!-- Active Runs -->
      <section>
        <h2>üîÑ Active Runs</h2>
        <div id="active-runs">
          <p style="color: var(--text-muted);">Loading...</p>
        </div>
      </section>
    </div>

    <!-- Promoted Models (Holy Grail) -->
    <section class="holy-grail">
      <h2>üèÜ Promoted Models (Holy Grail)</h2>
      <p style="color: var(--text-muted); font-size: 0.85rem;">
        Models that achieved: SQN 3-5 | Profit Factor 2-4 | 200-10k trades | Consistent weekly volume
      </p>
      <div id="promoted-models">
        <p style="color: var(--text-muted);">Loading...</p>
      </div>
    </section>

    <!-- All Runs History -->
    <section>
      <h2>üìú Evolution History</h2>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
        <button class="secondary" onclick="loadRuns()">üîÑ Refresh</button>
        <select id="filter-status" onchange="loadRuns()">
          <option value="">All Statuses</option>
          <option value="RUNNING">Running</option>
          <option value="COMPLETED">Completed</option>
          <option value="PROMOTED">Promoted</option>
          <option value="FAILED">Failed</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Symbol</th>
            <th>Status</th>
            <th>Generation</th>
            <th>Best SQN</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="runs-table">
          <tr><td colspan="7" style="color: var(--text-muted);">Loading...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Run Details Modal -->
    <section id="run-details" style="display: none;">
      <h2>üìà Run Details: <span id="detail-run-id"></span></h2>
      <div class="row">
        <div class="stat-card">
          <div class="stat-value" id="detail-generation">-</div>
          <div class="stat-label">Current Generation</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="detail-sqn">-</div>
          <div class="stat-label">Best SQN</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="detail-jobs">-</div>
          <div class="stat-label">Completed Jobs</div>
        </div>
      </div>
      
      <h3 style="margin-top: 1rem;">üìä Per-Generation Results (Epochs)</h3>
      <div id="generation-breakdown">
        <p style="color: var(--text-muted);">Loading...</p>
      </div>
      
      <h3 style="margin-top: 1rem;">üß¨ Lineage (Evolution Path)</h3>
      <div id="lineage-tree">
        <p style="color: var(--text-muted);">Loading...</p>
      </div>
      
      <h3 style="margin-top: 1rem;">üèÖ Top Results</h3>
      <table>
        <thead>
          <tr>
            <th>Model</th>
            <th>SQN</th>
            <th>Profit Factor</th>
            <th>Trades</th>
            <th>Threshold</th>
            <th>Regime</th>
          </tr>
        </thead>
        <tbody id="results-table">
        </tbody>
      </table>
      
      <button class="secondary" onclick="hideDetails()" style="margin-top: 1rem;">Close</button>
    </section>

    <!-- Promoted Model Detail Modal -->
    <section id="promoted-detail" style="display: none;">
      <h2>üèÜ Model Details: <span id="promoted-model-id"></span></h2>
      
      <div class="row">
        <div class="stat-card">
          <div class="stat-value" id="promoted-sqn">-</div>
          <div class="stat-label">SQN</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="promoted-pf">-</div>
          <div class="stat-label">Profit Factor</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="promoted-trades">-</div>
          <div class="stat-label">Trades</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="promoted-gen">-</div>
          <div class="stat-label">Generation</div>
        </div>
      </div>
      
      <h3 style="margin-top: 1rem;">üìã Model Configuration</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div>
          <label>Symbol</label>
          <pre id="promoted-symbol" style="margin-top: 0.25rem; padding: 0.5rem;">-</pre>
        </div>
        <div>
          <label>Threshold</label>
          <pre id="promoted-threshold" style="margin-top: 0.25rem; padding: 0.5rem;">-</pre>
        </div>
      </div>
      
      <h3 style="margin-top: 1rem;">‚öôÔ∏è Hyperparameters</h3>
      <pre id="promoted-hyperparams" style="max-height: 200px;">-</pre>
      
      <h3 style="margin-top: 1rem;">üìä Features Used (<span id="promoted-feature-count">0</span>)</h3>
      <pre id="promoted-features" style="max-height: 200px;">-</pre>
      
      <h3 style="margin-top: 1rem;">üß¨ Lineage (How This Model Evolved)</h3>
      <div id="promoted-lineage">
        <p style="color: var(--text-muted);">Loading...</p>
      </div>
      
      <h3 style="margin-top: 1rem;">üìà Regime Configuration</h3>
      <pre id="promoted-regime" style="max-height: 150px;">-</pre>
      
      <h3 style="margin-top: 1rem;">üìÑ Full Simulation Result</h3>
      <pre id="promoted-full-result" style="max-height: 300px;">-</pre>
      
      <button class="secondary" onclick="hidePromotedDetail()" style="margin-top: 1rem;">Close</button>
    </section>
  </div>

  <script>
    const API = '';  // Same origin
    
    // Auto-refresh every 10 seconds
    setInterval(() => {
      loadStats();
      loadRuns();
      loadPromoted();
    }, 10000);
    
    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadRuns();
      loadPromoted();
    });
    
    async function loadStats() {
      try {
        const [runsRes, pendingRes, promotedRes] = await Promise.all([
          fetch(`${API}/runs`),
          fetch(`${API}/jobs/pending`),
          fetch(`${API}/promoted`)
        ]);
        
        const runs = await runsRes.json();
        const pending = await pendingRes.json();
        const promoted = await promotedRes.json();
        
        document.getElementById('stat-runs').textContent = runs.count || 0;
        document.getElementById('stat-pending').textContent = pending.pending || 0;
        document.getElementById('stat-promoted').textContent = promoted.count || 0;
        
        // Count running runs as "workers" for now
        const runningCount = (runs.runs || []).filter(r => r.status === 'RUNNING').length;
        document.getElementById('stat-workers').textContent = runningCount;
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }
    
    async function loadRuns() {
      try {
        const status = document.getElementById('filter-status').value;
        const url = status ? `${API}/runs?status=${status}` : `${API}/runs`;
        const res = await fetch(url);
        const data = await res.json();
        
        const tbody = document.getElementById('runs-table');
        
        if (!data.runs || data.runs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="color: var(--text-muted);">No evolution runs yet. Start one above!</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.runs.map(run => `
          <tr class="clickable" onclick="showDetails('${run.id}')">
            <td><code>${run.id.substring(0, 8)}...</code></td>
            <td>${run.symbol}</td>
            <td><span class="badge ${run.status.toLowerCase()}">${run.status}</span></td>
            <td>${run.current_generation} / ${run.max_generations}</td>
            <td>${run.best_sqn ? run.best_sqn.toFixed(2) : '-'}</td>
            <td>${new Date(run.created_at).toLocaleString()}</td>
            <td><button class="secondary" onclick="event.stopPropagation(); showDetails('${run.id}')">View</button></td>
          </tr>
        `).join('');
        
        // Update active runs section
        const activeRuns = data.runs.filter(r => r.status === 'RUNNING' || r.status === 'PENDING');
        const activeDiv = document.getElementById('active-runs');
        
        if (activeRuns.length === 0) {
          activeDiv.innerHTML = '<p style="color: var(--text-muted);">No active runs</p>';
        } else {
          activeDiv.innerHTML = activeRuns.map(run => `
            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${run.symbol}</strong>
                  <span class="badge ${run.status.toLowerCase()}" style="margin-left: 0.5rem;">${run.status}</span>
                </div>
                <code style="font-size: 0.8rem;">${run.id.substring(0, 8)}</code>
              </div>
              <div style="margin-top: 0.5rem;">
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted);">
                  <span>Generation ${run.current_generation} of ${run.max_generations}</span>
                  <span>Best SQN: ${run.best_sqn ? run.best_sqn.toFixed(2) : '-'}</span>
                </div>
                <div class="progress-bar" style="margin-top: 0.25rem;">
                  <div class="progress-fill" style="width: ${(run.current_generation / run.max_generations) * 100}%"></div>
                </div>
              </div>
            </div>
          `).join('');
        }
      } catch (e) {
        console.error('Failed to load runs:', e);
      }
    }
    
    async function loadPromoted() {
      try {
        const res = await fetch(`${API}/promoted`);
        const data = await res.json();
        
        const container = document.getElementById('promoted-models');
        
        if (!data.promoted || data.promoted.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted);">No promoted models yet. Keep evolving!</p>';
          return;
        }
        
        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Model ID</th>
                <th>Symbol</th>
                <th>SQN</th>
                <th>Profit Factor</th>
                <th>Trades</th>
                <th>Generation</th>
                <th>Promoted At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.promoted.map(m => `
                <tr style="cursor: pointer;" onclick="showPromotedDetail('${m.id}')">
                  <td><code>${m.model_id.substring(0, 8)}...</code></td>
                  <td>${m.ticker}</td>
                  <td style="color: var(--success); font-weight: bold;">${m.sqn.toFixed(2)}</td>
                  <td>${m.profit_factor.toFixed(2)}</td>
                  <td>${m.trade_count}</td>
                  <td>${m.generation}</td>
                  <td>${new Date(m.promoted_at).toLocaleString()}</td>
                  <td><button class="secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Details</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        console.error('Failed to load promoted:', e);
      }
    }
    
    async function showPromotedDetail(promotedId) {
      try {
        const res = await fetch(`${API}/promoted/${promotedId}`);
        const data = await res.json();
        
        document.getElementById('promoted-detail').style.display = 'block';
        document.getElementById('promoted-model-id').textContent = data.model_id?.substring(0, 12) + '...';
        document.getElementById('promoted-sqn').textContent = data.sqn?.toFixed(2) || '-';
        document.getElementById('promoted-pf').textContent = data.profit_factor?.toFixed(2) || '-';
        document.getElementById('promoted-trades').textContent = data.trade_count || '-';
        document.getElementById('promoted-gen').textContent = data.generation || '-';
        document.getElementById('promoted-symbol').textContent = data.ticker || '-';
        document.getElementById('promoted-threshold').textContent = data.threshold || '-';
        
        // Model config (features, hyperparams)
        const config = data.model_config || {};
        const features = config.features || [];
        document.getElementById('promoted-feature-count').textContent = features.length;
        document.getElementById('promoted-features').textContent = features.length > 0 
          ? features.join('\n') 
          : 'No feature data available';
        document.getElementById('promoted-hyperparams').textContent = config.hyperparams 
          ? JSON.stringify(config.hyperparams, null, 2) 
          : 'No hyperparameter data available';
        
        // Regime config
        document.getElementById('promoted-regime').textContent = data.regime_config 
          ? JSON.stringify(data.regime_config, null, 2) 
          : '-';
        
        // Full result
        document.getElementById('promoted-full-result').textContent = data.full_result 
          ? JSON.stringify(data.full_result, null, 2) 
          : '-';
        
        // Lineage
        const lineageDiv = document.getElementById('promoted-lineage');
        if (data.lineage && data.lineage.length > 0) {
          lineageDiv.innerHTML = data.lineage.map((l, i) => `
            <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid var(--primary);">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge">Gen ${l.generation}</span>
                <code style="font-size: 0.8rem;">${l.parent_model_id?.substring(0, 8) || 'seed'} ‚Üí ${l.child_model_id?.substring(0, 8)}</code>
              </div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">
                <strong>Reason:</strong> ${l.pruning_reason || 'Initial'}
              </div>
              <div style="font-size: 0.85rem;">
                <span style="color: var(--danger);">Pruned:</span> 
                ${(l.pruned_features || []).slice(0, 5).join(', ')}${(l.pruned_features || []).length > 5 ? ` (+${l.pruned_features.length - 5} more)` : ''}
              </div>
              <div style="font-size: 0.85rem;">
                <span style="color: var(--success);">Remaining:</span> 
                ${(l.remaining_features || []).length} features
              </div>
            </div>
          `).join('');
        } else {
          lineageDiv.innerHTML = '<p style="color: var(--text-muted);">This is a first-generation model (no ancestry)</p>';
        }
        
        // Scroll to details
        document.getElementById('promoted-detail').scrollIntoView({ behavior: 'smooth' });
      } catch (e) {
        console.error('Failed to load promoted detail:', e);
        alert('Failed to load model details');
      }
    }
    
    function hidePromotedDetail() {
      document.getElementById('promoted-detail').style.display = 'none';
    }
    
    async function showDetails(runId) {
      try {
        // Fetch both endpoints in parallel
        const [runRes, genRes] = await Promise.all([
          fetch(`${API}/runs/${runId}`),
          fetch(`${API}/runs/${runId}/generations`)
        ]);
        const data = await runRes.json();
        const genData = await genRes.json();
        
        document.getElementById('run-details').style.display = 'block';
        document.getElementById('detail-run-id').textContent = runId.substring(0, 12) + '...';
        document.getElementById('detail-generation').textContent = data.run.current_generation;
        document.getElementById('detail-sqn').textContent = data.run.best_sqn ? data.run.best_sqn.toFixed(2) : '-';
        document.getElementById('detail-jobs').textContent = data.completed_jobs;
        
        // Per-generation breakdown
        const genDiv = document.getElementById('generation-breakdown');
        if (genData.generations && genData.generations.length > 0) {
          genDiv.innerHTML = genData.generations.map(g => `
            <div style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 1rem; margin-bottom: 0.75rem; border-left: 3px solid ${g.best_sqn >= 3 ? 'var(--success)' : 'var(--primary)'};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span class="badge ${g.completed === g.total_jobs ? 'completed' : 'running'}">Generation ${g.generation}</span>
                <span style="font-size: 0.85rem; color: var(--text-muted);">
                  ${g.completed}/${g.total_jobs} jobs (${g.pending} pending, ${g.running} running)
                </span>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 0.75rem;">
                <div>
                  <div style="font-size: 0.75rem; color: var(--text-muted);">Best SQN</div>
                  <div style="font-size: 1.1rem; font-weight: 600; color: ${g.best_sqn >= 3 ? 'var(--success)' : 'var(--text)'};">${g.best_sqn?.toFixed(2) || '-'}</div>
                </div>
                <div>
                  <div style="font-size: 0.75rem; color: var(--text-muted);">Best PF</div>
                  <div style="font-size: 1.1rem; font-weight: 600;">${g.best_pf?.toFixed(2) || '-'}</div>
                </div>
                <div>
                  <div style="font-size: 0.75rem; color: var(--text-muted);">Features</div>
                  <div style="font-size: 1.1rem; font-weight: 600;">${(g.remaining_features || []).length}</div>
                </div>
              </div>
              ${g.pruned_features && g.pruned_features.length > 0 ? `
                <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                  <span style="color: var(--danger);">Pruned:</span> 
                  ${g.pruned_features.slice(0, 3).join(', ')}${g.pruned_features.length > 3 ? ` (+${g.pruned_features.length - 3} more)` : ''}
                </div>
              ` : ''}
              ${g.top_results && g.top_results.length > 0 ? `
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                  <strong>Top Results:</strong>
                  ${g.top_results.map(r => `
                    <div style="display: inline-block; background: rgba(0,0,0,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; margin: 0.25rem 0.25rem 0 0;">
                      SQN ${r.sqn?.toFixed(2) || '?'} | PF ${r.profit_factor?.toFixed(2) || '?'} | ${r.trade_count || '?'} trades
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `).join('');
        } else {
          genDiv.innerHTML = '<p style="color: var(--text-muted);">No generation data yet</p>';
        }
        
        // Lineage tree
        const lineageDiv = document.getElementById('lineage-tree');
        if (data.lineage && data.lineage.length > 0) {
          lineageDiv.innerHTML = data.lineage.map((l, i) => {
            const pruned = typeof l.pruned_features === 'string' ? JSON.parse(l.pruned_features) : (l.pruned_features || []);
            const remaining = typeof l.remaining_features === 'string' ? JSON.parse(l.remaining_features) : (l.remaining_features || []);
            return `
            <div style="display: flex; flex-direction: column; gap: 0.25rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 0.25rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge">Gen ${l.generation}</span>
                <span style="color: var(--text-muted);">‚Üí</span>
                <code style="font-size: 0.8rem;">${l.child_model_id.substring(0, 8)}</code>
                <span style="color: var(--text-muted); font-size: 0.85rem;">
                  (${remaining.length} features, pruned ${pruned.length})
                </span>
              </div>
              ${l.pruning_reason ? `<div style="font-size: 0.8rem; color: var(--text-muted);">${l.pruning_reason}</div>` : ''}
            </div>
          `}).join('');
        } else {
          lineageDiv.innerHTML = '<p style="color: var(--text-muted);">No lineage data yet</p>';
        }
        
        // Results table
        const resultsTable = document.getElementById('results-table');
        if (data.results_sample && data.results_sample.length > 0) {
          resultsTable.innerHTML = data.results_sample.map(r => {
            const result = typeof r.result === 'string' ? JSON.parse(r.result) : r.result;
            return `
              <tr>
                <td><code>${r.model_id.substring(0, 8)}</code></td>
                <td>${result?.sqn?.toFixed(2) || '-'}</td>
                <td>${result?.profit_factor?.toFixed(2) || '-'}</td>
                <td>${result?.trade_count || result?.trades_count || '-'}</td>
                <td>${result?.params?.threshold || '-'}</td>
                <td>${JSON.stringify(result?.params?.regime_config || '-')}</td>
              </tr>
            `;
          }).join('');
        } else {
          resultsTable.innerHTML = '<tr><td colspan="6" style="color: var(--text-muted);">No results yet</td></tr>';
        }
        
        // Scroll to details
        document.getElementById('run-details').scrollIntoView({ behavior: 'smooth' });
      } catch (e) {
        console.error('Failed to load run details:', e);
        alert('Failed to load run details');
      }
    }
    
    function hideDetails() {
      document.getElementById('run-details').style.display = 'none';
    }
    
    // Form submission
    document.getElementById('evolve-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = '‚è≥ Starting...';
      
      const thresholds = document.getElementById('thresholds').value
        .split(',')
        .map(t => parseFloat(t.trim()))
        .filter(t => !isNaN(t));
      
      const payload = {
        seed_model_id: document.getElementById('seed-model-id').value || null,
        symbol: document.getElementById('symbol').value,
        algorithm: document.getElementById('algorithm').value,
        target_col: document.getElementById('target-col').value,
        max_generations: parseInt(document.getElementById('max-generations').value),
        target_transform: document.getElementById('target-transform').value,
        timeframe: document.getElementById('timeframe').value,
        thresholds: thresholds,
        regime_configs: [
          {"regime_gmm": [0]},
          {"regime_gmm": [1]},
          {"regime_vix": [0, 1]}
        ],
        sqn_min: parseFloat(document.getElementById('sqn-min').value),
        sqn_max: parseFloat(document.getElementById('sqn-max').value),
        profit_factor_min: parseFloat(document.getElementById('pf-min').value),
        profit_factor_max: parseFloat(document.getElementById('pf-max').value),
        trade_count_min: parseInt(document.getElementById('trades-min').value),
        trade_count_max: parseInt(document.getElementById('trades-max').value)
      };
      
      try {
        const res = await fetch(`${API}/evolve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        const resultDiv = document.getElementById('evolve-result');
        resultDiv.style.display = 'block';
        
        if (res.ok) {
          resultDiv.innerHTML = `
            <div style="background: rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
              ‚úÖ Evolution started! Monitoring in Active Runs section.
            </div>
          `;
          loadRuns();
          loadStats();
        } else {
          resultDiv.innerHTML = `
            <div style="background: rgba(239, 68, 68, 0.2); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
              ‚ùå Error: ${data.detail || JSON.stringify(data)}
            </div>
          `;
        }
      } catch (e) {
        document.getElementById('evolve-result').innerHTML = `
          <div style="background: rgba(239, 68, 68, 0.2); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
            ‚ùå Network error: ${e.message}
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üß¨ Start Evolution';
      }
    });
  </script>
</body>
</html>
